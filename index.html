<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIèŠå¤©åŠ©æ‰‹</title>
  <!-- å¼•å…¥Markdownæ¸²æŸ“åº“ -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/highlight.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: #f8f9fa;
      color: #333;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    .sidebar {
      width: 250px;
      background-color: #2d2d2d;
      color: #f8f9fa;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #444;
    }
    .sidebar-header {
      padding: 15px;
      border-bottom: 1px solid #444;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .sidebar-content {
      flex: 1;
      overflow-y: auto;
    }
    .chat-list {
      list-style: none;
    }
    .chat-item {
      padding: 12px 15px;
      cursor: pointer;
      border-bottom: 1px solid #444;
      transition: background-color 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-item:hover {
      background-color: #3d3d3d;
    }
    .chat-item.active {
      background-color: #4d4d4d;
      border-left: 3px solid #e0e0e0;
    }
    .chat-item-content {
      flex: 1;
      overflow: hidden;
    }
    .chat-item-title {
      font-weight: 500;
      margin-bottom: 5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .chat-item-preview {
      font-size: 12px;
      color: #aaa;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .chat-item-delete {
      opacity: 0;
      transition: opacity 0.2s;
      background: none;
      border: none;
      color: #aaa;
      cursor: pointer;
      padding: 5px;
      margin-left: 10px;
    }
    .chat-item:hover .chat-item-delete {
      opacity: 1;
    }
    .chat-item-delete:hover {
      color: #ff4444;
    }
    .sidebar-footer {
      padding: 15px;
      border-top: 1px solid #444;
    }
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: #fff;
    }
    .chat-header {
      padding: 15px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #f8f9fa;
    }
    .model-selector {
      display: flex;
      align-items: center;
    }
    .model-selector select {
      margin-left: 10px;
      padding: 5px;
      border-radius: 4px;
      border: 1px solid #ddd;
      background-color: #fff;
    }
    .chat-messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      background-color: #f8f9fa;
    }
    .message {
      max-width: 80%;
      margin-bottom: 15px;
      padding: 10px 15px;
      border-radius: 18px;
      position: relative;
      line-height: 1.5;
    }
    .message-user {
      align-self: flex-end;
      background-color: #e0e0e0;
      color: #333;
      border-bottom-right-radius: 5px;
    }
    .message-ai {
      align-self: flex-start;
      background-color: #f1f1f1;
      color: #333;
      border-bottom-left-radius: 5px;
    }
    .message-time {
      font-size: 10px;
      color: #999;
      margin-top: 5px;
      text-align: right;
    }
    .chat-input {
      padding: 15px;
      border-top: 1px solid #eee;
      background-color: #f8f9fa;
    }
    .input-container {
      display: flex;
      position: relative;
    }
    .message-input {
      flex: 1;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 24px;
      outline: none;
      resize: none;
      max-height: 120px;
      overflow-y: auto;
      background-color: #fff;
    }
    .send-button {
      margin-left: 10px;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background-color: #666;
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
    }
    .send-button:hover {
      background-color: #888;
    }
    .send-button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .button {
      padding: 8px 12px;
      background-color: #666;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .button:hover {
      background-color: #888;
    }
    .button-secondary {
      background-color: #555;
    }
    .button-secondary:hover {
      background-color: #777;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      width: 500px;
      max-width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .modal-title {
      font-size: 18px;
      font-weight: 500;
    }
    .close-button {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #999;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #fff;
    }
    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }
    .model-list {
      margin-top: 20px;
      border-top: 1px solid #ddd;
      padding-top: 15px;
    }
    .model-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    .model-item-info {
      flex: 1;
    }
    .model-item-name {
      font-weight: 500;
    }
    .model-item-url {
      font-size: 12px;
      color: #999;
    }
    .model-item-actions {
      display: flex;
      gap: 5px;
    }
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #999;
      text-align: center;
      padding: 20px;
      background-color: #f8f9fa;
    }
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    .empty-state-text {
      margin-bottom: 20px;
    }
    /* Markdownæ ·å¼ */
    .markdown-content {
      line-height: 1.6;
    }
    .markdown-content h1, .markdown-content h2, .markdown-content h3, 
    .markdown-content h4, .markdown-content h5, .markdown-content h6 {
      margin-top: 1em;
      margin-bottom: 0.5em;
    }
    .markdown-content p {
      margin-bottom: 1em;
    }
    .markdown-content ul, .markdown-content ol {
      margin-bottom: 1em;
      padding-left: 2em;
    }
    .markdown-content pre {
      background-color: #f0f0f0;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      margin-bottom: 1em;
    }
    .markdown-content code {
      background-color: #f0f0f0;
      padding: 2px 4px;
      border-radius: 3px;
      font-family: monospace;
    }
    .markdown-content pre code {
      padding: 0;
      background-color: transparent;
    }
    .markdown-content blockquote {
      border-left: 4px solid #ddd;
      padding-left: 1em;
      margin-left: 0;
      margin-bottom: 1em;
      color: #666;
    }
    .markdown-content table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 1em;
    }
    .markdown-content table th, .markdown-content table td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    .markdown-content table th {
      background-color: #f0f0f0;
      text-align: left;
    }
    .markdown-content img {
      max-width: 100%;
      height: auto;
    }
    /* æš—è‰²ä¸»é¢˜ä»£ç é«˜äº® */
    .hljs {
      background: #282c34;
      color: #abb2bf;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h2>èŠå¤©è®°å½•</h2>
        <button id="new-chat-btn" class="button">æ–°å¯¹è¯</button>
      </div>
      <div class="sidebar-content">
        <ul class="chat-list" id="chatList">
          <!-- èŠå¤©åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </ul>
      </div>
      <div class="sidebar-footer">
        <button id="settings-btn" class="button button-secondary">æ¨¡å‹è®¾ç½®</button>
      </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content">
      <div id="empty-state" class="empty-state">
        <div class="empty-state-icon">ğŸ’¬</div>
        <div class="empty-state-text">å¼€å§‹ä¸€ä¸ªæ–°çš„å¯¹è¯ï¼Œæˆ–ä»å·¦ä¾§é€‰æ‹©å†å²è®°å½•</div>
        <button id="start-chat-btn" class="button">å¼€å§‹æ–°å¯¹è¯</button>
      </div>

      <div id="chat-container" style="display: none; flex-direction: column; height: 100%;">
        <div class="chat-header">
          <h2 id="chat-title">æ–°å¯¹è¯</h2>
          <div class="model-selector">
            <span>æ¨¡å‹:</span>
            <select id="model-select">
              <!-- æ¨¡å‹é€‰é¡¹ -->
            </select>
          </div>
        </div>
        <div id="chat-messages" class="chat-messages">
          <!-- æ¶ˆæ¯å†…å®¹ -->
        </div>
        <div class="chat-input">
          <div class="input-container">
            <textarea id="message-input" class="message-input" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1"></textarea>
            <button id="send-button" class="send-button" disabled>â¤</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- æ¨¡å‹è®¾ç½®å¼¹çª— -->
  <div id="settings-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">æ¨¡å‹è®¾ç½®</h3>
        <button class="close-button" id="close-settings">&times;</button>
      </div>
      <div class="form-group">
        <label for="model-name">æ¨¡å‹åç§°</label>
        <input type="text" id="model-name" placeholder="ä¾‹å¦‚: GPT-3.5">
      </div>
      <div class="form-group">
        <label for="model-id">æ¨¡å‹ID</label>
        <input type="text" id="model-id" placeholder="ä¾‹å¦‚: gpt-3.5-turbo">
      </div>
      <div class="form-group">
        <label for="api-url">APIåœ°å€</label>
        <input type="text" id="api-url" placeholder="ä¾‹å¦‚: https://api.openai.com/v1/chat/completions">
      </div>
      <div class="form-group">
        <label for="api-key">APIå¯†é’¥</label>
        <input type="password" id="api-key" placeholder="è¾“å…¥æ‚¨çš„APIå¯†é’¥">
      </div>
      <div class="form-group">
        <label for="system-prompt">ç³»ç»Ÿæç¤ºè¯</label>
        <textarea id="system-prompt" placeholder="è¾“å…¥ç³»ç»Ÿæç¤ºè¯ï¼Œå®šä¹‰AIåŠ©æ‰‹çš„è¡Œä¸ºå’Œç‰¹æ€§">ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹ï¼Œèƒ½å¤Ÿå›ç­”ç”¨æˆ·çš„å„ç§é—®é¢˜ã€‚</textarea>
      </div>
      <button id="add-model-btn" class="button">æ·»åŠ æ¨¡å‹</button>

      <div class="model-list">
        <h4>å·²æ·»åŠ çš„æ¨¡å‹</h4>
        <div id="model-list-container">
          <!-- æ¨¡å‹åˆ—è¡¨ -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // è·å–DOMå…ƒç´ 
    const chatList = document.getElementById('chatList');
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const newChatBtn = document.getElementById('new-chat-btn');
    const startChatBtn = document.getElementById('start-chat-btn');
    const settingsBtn = document.getElementById('settings-btn');
    const modelSelect = document.getElementById('model-select');
    const chatTitle = document.getElementById('chat-title');
    const emptyState = document.getElementById('empty-state');
    const chatContainer = document.getElementById('chat-container');
    
    // è®¾ç½®ç›¸å…³å…ƒç´ 
    const settingsModal = document.getElementById('settings-modal');
    const closeSettings = document.getElementById('close-settings');
    const modelName = document.getElementById('model-name');
    const modelId = document.getElementById('model-id');
    const apiUrl = document.getElementById('api-url');
    const apiKey = document.getElementById('api-key');
    const systemPrompt = document.getElementById('system-prompt');
    const addModelBtn = document.getElementById('add-model-btn');
    const modelListContainer = document.getElementById('model-list-container');
    
    // å½“å‰ä¼šè¯ID
    let currentSessionId = null;
    // å½“å‰ä¼šè¯æ¶ˆæ¯
    let currentMessages = [];
    // æ¨¡å‹é…ç½®åˆ—è¡¨
    let modelConfigs = [];
    
    // åˆå§‹åŒ–
    function init() {
      // åŠ è½½æ¨¡å‹é…ç½®
      loadModelConfigs();
      // åŠ è½½èŠå¤©è®°å½•
      loadChatSessions();
      // è®¾ç½®äº‹ä»¶ç›‘å¬
      setupEventListeners();
      // é…ç½®Markdownæ¸²æŸ“å™¨
      configureMarkdown();
    }
    
    // é…ç½®Markdownæ¸²æŸ“å™¨
    function configureMarkdown() {
      marked.setOptions({
        highlight: function(code, lang) {
          const language = hljs.getLanguage(lang) ? lang : 'plaintext';
          return hljs.highlight(code, { language }).value;
        },
        langPrefix: 'hljs language-',
        gfm: true,
        breaks: true
      });
    }
    
    // åŠ è½½æ¨¡å‹é…ç½®
    function loadModelConfigs() {
      modelConfigs = window.preload.dbUtil.getModelConfig() || [];
      updateModelSelect();
      updateModelList();
    }
    
    // æ›´æ–°æ¨¡å‹é€‰æ‹©ä¸‹æ‹‰æ¡†
    function updateModelSelect() {
      modelSelect.innerHTML = '';
      
      if (modelConfigs.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'è¯·å…ˆæ·»åŠ æ¨¡å‹';
        modelSelect.appendChild(option);
        modelSelect.disabled = true;
      } else {
        modelSelect.disabled = false;
        modelConfigs.forEach((config, index) => {
          const option = document.createElement('option');
          option.value = index;
          option.textContent = config.name;
          modelSelect.appendChild(option);
        });
      }
    }
    
    // æ›´æ–°æ¨¡å‹åˆ—è¡¨
    function updateModelList() {
      modelListContainer.innerHTML = '';
      
      if (modelConfigs.length === 0) {
        modelListContainer.innerHTML = '<p>æš‚æ— æ¨¡å‹ï¼Œè¯·æ·»åŠ </p>';
        return;
      }
      
      modelConfigs.forEach((config, index) => {
        const modelItem = document.createElement('div');
        modelItem.className = 'model-item';
        
        const modelInfo = document.createElement('div');
        modelInfo.className = 'model-item-info';
        
        const modelItemName = document.createElement('div');
        modelItemName.className = 'model-item-name';
        modelItemName.textContent = config.name;
        
        const modelItemUrl = document.createElement('div');
        modelItemUrl.className = 'model-item-url';
        modelItemUrl.textContent = `${config.url} (${config.model})`;
        
        const modelItemPrompt = document.createElement('div');
        modelItemPrompt.className = 'model-item-url';
        modelItemPrompt.textContent = `ç³»ç»Ÿæç¤ºè¯: ${config.systemPrompt ? (config.systemPrompt.substring(0, 30) + '...') : 'æ— '}`;
        
        modelInfo.appendChild(modelItemName);
        modelInfo.appendChild(modelItemUrl);
        modelInfo.appendChild(modelItemPrompt);
        
        const modelActions = document.createElement('div');
        modelActions.className = 'model-item-actions';
        
        const editBtn = document.createElement('button');
        editBtn.className = 'button';
        editBtn.textContent = 'ç¼–è¾‘';
        editBtn.onclick = () => editModel(index);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'button button-secondary';
        deleteBtn.textContent = 'åˆ é™¤';
        deleteBtn.onclick = () => deleteModel(index);
        
        modelActions.appendChild(editBtn);
        modelActions.appendChild(deleteBtn);
        
        modelItem.appendChild(modelInfo);
        modelItem.appendChild(modelActions);
        
        modelListContainer.appendChild(modelItem);
      });
    }
    
    // ç¼–è¾‘æ¨¡å‹
    function editModel(index) {
      const config = modelConfigs[index];
      modelName.value = config.name;
      modelId.value = config.model;
      apiUrl.value = config.url;
      apiKey.value = config.key;
      systemPrompt.value = config.systemPrompt || 'ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹ï¼Œèƒ½å¤Ÿå›ç­”ç”¨æˆ·çš„å„ç§é—®é¢˜ã€‚';
      
      // åˆ é™¤åŸæ¨¡å‹
      modelConfigs.splice(index, 1);
      
      // æ›´æ–°UI
      updateModelSelect();
      updateModelList();
    }
    
    // åŠ è½½èŠå¤©è®°å½•
    function loadChatSessions() {
      const sessions = window.preload.dbUtil.getAllSessions();
      
      chatList.innerHTML = '';
      
      if (sessions.length === 0) {
        return;
      }
      
      sessions.forEach(session => {
        addChatItemToList(session);
      });
    }
    
    // æ·»åŠ èŠå¤©é¡¹åˆ°åˆ—è¡¨
    function addChatItemToList(session) {
      const chatItem = document.createElement('li');
      chatItem.className = 'chat-item';
      chatItem.dataset.id = session.id;
      
      if (currentSessionId === session.id) {
        chatItem.classList.add('active');
      }
      
      const lastMessage = session.messages[session.messages.length - 1];
      const title = session.messages[0]?.content.substring(0, 20) || 'æ–°å¯¹è¯';
      const preview = lastMessage ? `${lastMessage.role === 'user' ? 'ä½ : ' : 'AI: '}${lastMessage.content.substring(0, 30)}` : '';
      
      chatItem.innerHTML = `
        <div class="chat-item-title">${title}</div>
        <div class="chat-item-preview">${preview}</div>
      `;
      
      chatItem.addEventListener('click', () => {
        loadChatSession(session.id);
      });
      
      chatList.appendChild(chatItem);
    }
    
    // åŠ è½½èŠå¤©ä¼šè¯
    function loadChatSession(sessionId) {
      currentSessionId = sessionId;
      currentMessages = window.preload.dbUtil.getChatHistory(sessionId) || [];
      
      // æ›´æ–°UI
      updateChatUI();
      
      // æ›´æ–°æ´»åŠ¨çŠ¶æ€
      document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.id === sessionId) {
          item.classList.add('active');
        }
      });
    }
    
    // åˆ›å»ºæ–°ä¼šè¯
    function createNewChat() {
      currentSessionId = Date.now().toString();
      currentMessages = [];
      
      // æ›´æ–°UI
      updateChatUI();
      
      // æ·»åŠ åˆ°åˆ—è¡¨
      const session = {
        id: currentSessionId,
        messages: currentMessages,
        lastTime: Date.now()
      };
      
      addChatItemToList(session);
      
      // ä¿å­˜åˆ°æ•°æ®åº“
      window.preload.dbUtil.saveChatHistory(currentSessionId, currentMessages);
    }
    
    // æ›´æ–°èŠå¤©UI
    function updateChatUI() {
      if (currentSessionId === null) {
        emptyState.style.display = 'flex';
        chatContainer.style.display = 'none';
        return;
      }
      
      emptyState.style.display = 'none';
      chatContainer.style.display = 'flex';
      
      // æ›´æ–°æ ‡é¢˜
      if (currentMessages.length > 0) {
        chatTitle.textContent = currentMessages[0].content.substring(0, 20);
      } else {
        chatTitle.textContent = 'æ–°å¯¹è¯';
      }
      
      // æ›´æ–°æ¶ˆæ¯åˆ—è¡¨
      renderMessages();
    }
    
    // æ¸²æŸ“æ¶ˆæ¯
    function renderMessages() {
      chatMessages.innerHTML = '';
      
      currentMessages.forEach(msg => {
        const messageEl = document.createElement('div');
        messageEl.className = `message message-${msg.role === 'user' ? 'user' : 'ai'}`;
        
        const messageContent = document.createElement('div');
        
        // ä½¿ç”¨Markdownæ¸²æŸ“AIæ¶ˆæ¯
        if (msg.role === 'assistant') {
          messageContent.className = 'markdown-content';
          messageContent.innerHTML = marked.parse(msg.content);
          // é«˜äº®ä»£ç å—
          messageEl.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightElement(block);
          });
        } else {
          messageContent.textContent = msg.content;
        }
        
        const messageTime = document.createElement('div');
        messageTime.className = 'message-time';
        messageTime.textContent = formatTime(msg.timestamp);
        
        messageEl.appendChild(messageContent);
        messageEl.appendChild(messageTime);
        
        chatMessages.appendChild(messageEl);
      });
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
    }
    
    // å‘é€æ¶ˆæ¯
    async function sendMessage() {
      const message = messageInput.value.trim();
      if (!message) return;
      
      // å¦‚æœæ²¡æœ‰å½“å‰ä¼šè¯ï¼Œåˆ›å»ºä¸€ä¸ªæ–°ä¼šè¯
      if (currentSessionId === null) {
        createNewChat();
      }
      
      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      const userMessage = {
        role: 'user',
        content: message,
        timestamp: Date.now()
      };
      
      currentMessages.push(userMessage);
      
      // æ›´æ–°UI
      messageInput.value = '';
      renderMessages();
      
      // ä¿å­˜åˆ°æ•°æ®åº“
      window.preload.dbUtil.saveChatHistory(currentSessionId, currentMessages);
      
      // æ›´æ–°èŠå¤©åˆ—è¡¨
      loadChatSessions();
      
      // è·å–é€‰ä¸­çš„æ¨¡å‹
      const selectedModelIndex = modelSelect.value;
      if (selectedModelIndex === '' || modelConfigs.length === 0) {
        alert('è¯·å…ˆæ·»åŠ æ¨¡å‹é…ç½®');
        return;
      }
      
      const modelConfig = modelConfigs[selectedModelIndex];
      
      // å‡†å¤‡å‘é€ç»™AIçš„æ¶ˆæ¯
      const aiMessages = [];
      
      // æ·»åŠ ç³»ç»Ÿæç¤ºè¯
      if (modelConfig.systemPrompt) {
        aiMessages.push({
          role: 'system',
          content: modelConfig.systemPrompt
        });
      }
      
      // æ·»åŠ å¯¹è¯å†å²
      currentMessages.forEach(msg => {
        if (msg.role !== 'system') {
          aiMessages.push({
            role: msg.role,
            content: msg.content
          });
        }
      });
      
      try {
        // æ·»åŠ AIå›å¤å ä½
        const aiMessage = {
          role: 'assistant',
          content: '',
          timestamp: Date.now()
        };
        
        currentMessages.push(aiMessage);
        renderMessages();
        
        // è°ƒç”¨AI APIå¹¶å¤„ç†æµå¼è¾“å‡º
        await window.preload.aiUtil.callAI(modelConfig, aiMessages, (content) => {
          aiMessage.content = content;
          renderMessages();
        });
        
        // æ›´æ–°UIå’Œä¿å­˜æ•°æ®
        
        // ä¿å­˜åˆ°æ•°æ®åº“
        window.preload.dbUtil.saveChatHistory(currentSessionId, currentMessages);
        
        // æ›´æ–°èŠå¤©åˆ—è¡¨
        loadChatSessions();
      } catch (error) {
        console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
        
        // ç§»é™¤åŠ è½½ä¸­æ¶ˆæ¯
        currentMessages.pop();
        
        // æ·»åŠ é”™è¯¯æ¶ˆæ¯
        const errorMessage = {
          role: 'assistant',
          content: `å‘ç”Ÿé”™è¯¯: ${error.message}`,
          timestamp: Date.now()
        };
        
        currentMessages.push(errorMessage);
        
        // æ›´æ–°UI
        renderMessages();
        
        // ä¿å­˜åˆ°æ•°æ®åº“
        window.preload.dbUtil.saveChatHistory(currentSessionId, currentMessages);
      }
    }
    
    // æ·»åŠ æ¨¡å‹
    function addModel() {
      const name = modelName.value.trim();
      const model = modelId.value.trim();
      const url = apiUrl.value.trim();
      const key = apiKey.value.trim();
      const prompt = systemPrompt.value.trim();
      
      if (!name || !model || !url || !key) {
        alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
        return;
      }
      
      const newModel = { 
        name, 
        model, 
        url, 
        key,
        systemPrompt: prompt
      };
      
      modelConfigs.push(newModel);
      
      // ä¿å­˜åˆ°æ•°æ®åº“
      window.preload.dbUtil.saveModelConfig(modelConfigs);
      
      // æ›´æ–°UI
      updateModelSelect();
      updateModelList();
      
      // æ¸…ç©ºè¡¨å•
      modelName.value = '';
      modelId.value = '';
      apiUrl.value = '';
      apiKey.value = '';
      systemPrompt.value = 'ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹ï¼Œèƒ½å¤Ÿå›ç­”ç”¨æˆ·çš„å„ç§é—®é¢˜ã€‚';
    }
    
    // åˆ é™¤æ¨¡å‹
    function deleteModel(index) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¨¡å‹å—ï¼Ÿ')) {
        modelConfigs.splice(index, 1);
        
        // ä¿å­˜åˆ°æ•°æ®åº“
        window.preload.dbUtil.saveModelConfig(modelConfigs);
        
        // æ›´æ–°UI
        updateModelSelect();
        updateModelList();
      }
    }
    
    // è®¾ç½®äº‹ä»¶ç›‘å¬
    function setupEventListeners() {
      // å‘é€æ¶ˆæ¯
      sendButton.addEventListener('click', sendMessage);
      
      // æŒ‰Enterå‘é€æ¶ˆæ¯
      messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      
      // è¾“å…¥æ¡†å†…å®¹å˜åŒ–
      messageInput.addEventListener('input', () => {
        sendButton.disabled = messageInput.value.trim() === '';
      });
      
      // æ–°å»ºèŠå¤©
      newChatBtn.addEventListener('click', createNewChat);
      startChatBtn.addEventListener('click', createNewChat);
      
      // è®¾ç½®æŒ‰é’®
      settingsBtn.addEventListener('click', () => {
        settingsModal.classList.add('active');
      });
      
      // å…³é—­è®¾ç½®
      closeSettings.addEventListener('click', () => {
        settingsModal.classList.remove('active');
      });
      
      // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
      settingsModal.addEventListener('click', (e) => {
        if (e.target === settingsModal) {
          settingsModal.classList.remove('active');
        }
      });
      
      // æ·»åŠ æ¨¡å‹
      addModelBtn.addEventListener('click', addModel);
    }
    
    // æ¸²æŸ“èŠå¤©åˆ—è¡¨
    function renderChatList() {
      const chatList = document.getElementById('chatList')
      const sessions = window.utools.db.allDocs()
        .filter(doc => doc._id.startsWith('chat_history_'))
        .map(doc => {
          const sessionId = doc._id.replace('chat_history_', '')
          const messages = doc.value
          return {
            id: sessionId,
            title: messages[0]?.content?.slice(0, 20) || 'æ–°å¯¹è¯',
            preview: messages[messages.length - 1]?.content?.slice(0, 30) || '',
            lastTime: messages[messages.length - 1]?.timestamp || Date.now()
          }
        })
        .sort((a, b) => b.lastTime - a.lastTime)

      chatList.innerHTML = sessions.map(session => `
        <li class="chat-item ${currentSessionId === session.id ? 'active' : ''}" data-id="${session.id}">
          <div class="chat-item-content">
            <div class="chat-item-title">${session.title}</div>
            <div class="chat-item-preview">${session.preview}</div>
          </div>
          <button class="chat-item-delete" title="åˆ é™¤å¯¹è¯">Ã—</button>
        </li>
      `).join('')

      // æ·»åŠ åˆ é™¤äº‹ä»¶ç›‘å¬
      document.querySelectorAll('.chat-item-delete').forEach(button => {
        button.addEventListener('click', async (e) => {
          e.stopPropagation()
          const chatItem = button.closest('.chat-item')
          const sessionId = chatItem.dataset.id
          
          if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
            await window.utools.dbStorage.removeItem(`chat_history_${sessionId}`)
            if (currentSessionId === sessionId) {
              currentSessionId = null
              renderChatMessages([])
            }
            renderChatList()
          }
        })
      })

      // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬
      document.querySelectorAll('.chat-item').forEach(item => {
        item.addEventListener('click', () => {
          const sessionId = item.dataset.id
          loadChatHistory(sessionId)
        })
      })
    }
    
    // åˆå§‹åŒ–åº”ç”¨
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
