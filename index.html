<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIËÅäÂ§©Âä©Êâã</title>
  <!-- ÂºïÂÖ•MarkdownÊ∏≤ÊüìÂ∫ì -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/highlight.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: #f8f9fa;
      color: #333;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    .sidebar {
      width: 250px;
      background-color: #2d2d2d;
      color: #f8f9fa;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #444;
    }
    .sidebar-header {
      padding: 15px;
      border-bottom: 1px solid #444;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .sidebar-content {
      flex: 1;
      overflow-y: auto;
    }
    .chat-list {
      list-style: none;
    }
    .chat-item {
      padding: 12px 15px;
      cursor: pointer;
      border-bottom: 1px solid #444;
      transition: background-color 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-item:hover {
      background-color: #3d3d3d;
    }
    .chat-item.active {
      background-color: #4d4d4d;
      border-left: 3px solid #e0e0e0;
    }
    .chat-item-content {
      flex: 1;
      overflow: hidden;
    }
    .chat-item-title {
      font-weight: 500;
      margin-bottom: 5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .chat-item-preview {
      font-size: 12px;
      color: #aaa;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .chat-item-delete {
      width: 20px;
      height: 20px;
      opacity: 0;
      transition: opacity 0.2s;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
    }
    .chat-item:hover .chat-item-delete {
      opacity: 1;
    }
    .chat-item-delete:hover {
      color: #ff4444;
    }
    .sidebar-footer {
      padding: 15px;
      border-top: 1px solid #444;
    }
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: #fff;
    }
    .chat-header {
      padding: 15px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #f8f9fa;
    }
    .model-selector {
      display: flex;
      align-items: center;
    }
    .model-selector select {
      margin-left: 10px;
      padding: 5px;
      border-radius: 4px;
      border: 1px solid #ddd;
      background-color: #fff;
    }
    .chat-messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      background-color: #f8f9fa;
    }
    .message {
      max-width: 80%;
      margin-bottom: 15px;
      padding: 10px 15px;
      border-radius: 18px;
      position: relative;
      line-height: 1.5;
    }
    .message-user {
      align-self: flex-end;
      background-color: #e0e0e0;
      color: #333;
      border-bottom-right-radius: 5px;
    }
    .message-ai {
      align-self: flex-start;
      background-color: #f1f1f1;
      color: #333;
      border-bottom-left-radius: 5px;
    }
    .message-time {
      font-size: 10px;
      color: #999;
      margin-top: 5px;
      text-align: right;
    }
    .chat-input {
      padding: 15px;
      border-top: 1px solid #eee;
      background-color: #f8f9fa;
    }
    .input-container {
      display: flex;
      position: relative;
    }
    .message-input {
      flex: 1;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 24px;
      outline: none;
      resize: none;
      max-height: 120px;
      overflow-y: auto;
      background-color: #fff;
    }
    .send-button {
      margin-left: 10px;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background-color: #666;
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
    }
    .send-button:hover {
      background-color: #888;
    }
    .send-button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .button {
      padding: 8px 12px;
      background-color: #666;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .button:hover {
      background-color: #888;
    }
    .button-secondary {
      background-color: #555;
    }
    .button-secondary:hover {
      background-color: #777;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      width: 500px;
      max-width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .modal-title {
      font-size: 18px;
      font-weight: 500;
    }
    .close-button {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #999;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #fff;
    }
    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }
    .model-list {
      margin-top: 20px;
      border-top: 1px solid #ddd;
      padding-top: 15px;
    }
    .model-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    .model-item-info {
      flex: 1;
    }
    .model-item-name {
      font-weight: 500;
    }
    .model-item-url {
      font-size: 12px;
      color: #999;
    }
    .model-item-actions {
      display: flex;
      gap: 5px;
    }
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #999;
      text-align: center;
      padding: 20px;
      background-color: #f8f9fa;
    }
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    .empty-state-text {
      margin-bottom: 20px;
    }
    /* MarkdownÊ†∑Âºè */
    .markdown-content {
      line-height: 1.6;
    }
    .markdown-content h1, .markdown-content h2, .markdown-content h3, 
    .markdown-content h4, .markdown-content h5, .markdown-content h6 {
      margin-top: 1em;
      margin-bottom: 0.5em;
    }
    .markdown-content p {
      margin-bottom: 1em;
    }
    .markdown-content ul, .markdown-content ol {
      margin-bottom: 1em;
      padding-left: 2em;
    }
    .markdown-content pre {
      background-color: #f0f0f0;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      margin-bottom: 1em;
    }
    .markdown-content code {
      background-color: #f0f0f0;
      padding: 2px 4px;
      border-radius: 3px;
      font-family: monospace;
    }
    .markdown-content pre code {
      padding: 0;
      background-color: transparent;
    }
    .markdown-content blockquote {
      border-left: 4px solid #ddd;
      padding-left: 1em;
      margin-left: 0;
      margin-bottom: 1em;
      color: #666;
    }
    .markdown-content table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 1em;
    }
    .markdown-content table th, .markdown-content table td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    .markdown-content table th {
      background-color: #f0f0f0;
      text-align: left;
    }
    .markdown-content img {
      max-width: 100%;
      height: auto;
    }
    /* ÊöóËâ≤‰∏ªÈ¢ò‰ª£Á†ÅÈ´ò‰∫Æ */
    .hljs {
      background: #282c34;
      color: #abb2bf;
      border-radius: 4px;
    }
    /* ÈÄöÁü•ÁªÑ‰ª∂Ê†∑Âºè */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      background-color: #2d2d2d;
      color: #fff;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      gap: 10px;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.3s ease;
      z-index: 1000;
    }
    .notification.show {
      opacity: 1;
      transform: translateX(0);
    }
    .notification.success {
      background-color: #4caf50;
    }
    .notification.error {
      background-color: #f44336;
    }
    .notification.warning {
      background-color: #ff9800;
    }
    .notification-icon {
      font-size: 20px;
    }
    .notification-content {
      flex: 1;
    }
    .notification-close {
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      padding: 0;
      font-size: 16px;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    .notification-close:hover {
      opacity: 1;
    }
    /* Ê®°ÂûãÈÄâÊã©ÂºπÁ™óÊ†∑Âºè */
    .model-select-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #2d2d2d;
      color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      padding: 20px;
      min-width: 400px;
      max-width: 600px;
      z-index: 1001;
      display: none;
    }
    .model-select-modal.show {
      display: block;
    }
    .model-select-title {
      font-size: 14px;
      color: #999;
      margin-bottom: 10px;
      padding: 0 10px;
    }
    .model-select-search {
      margin-bottom: 10px;
    }
    .model-select-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .model-select-list {
      list-style: none;
      margin: 0;
      padding: 0;
      max-height: 300px;
      overflow-y: auto;
    }
    .model-select-item {
      padding: 8px 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background-color 0.2s;
      border-radius: 4px;
      margin: 2px 0;
    }
    .model-select-item:hover {
      background-color: #3d3d3d;
    }
    .model-select-item.active {
      background-color: #4d4d4d;
    }
    .model-select-name {
      flex: 1;
      font-size: 14px;
    }
    .model-select-shortcut {
      color: #999;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .model-select-item:hover .model-select-shortcut {
      opacity: 1;
    }
    /* ÊªöÂä®Êù°Ê†∑Âºè */
    .model-select-list::-webkit-scrollbar {
      width: 8px;
    }
    .model-select-list::-webkit-scrollbar-track {
      background: #2d2d2d;
    }
    .model-select-list::-webkit-scrollbar-thumb {
      background: #4d4d4d;
      border-radius: 4px;
    }
    .model-select-list::-webkit-scrollbar-thumb:hover {
      background: #5d5d5d;
    }
  </style>
</head>
<body>
  <!-- ÈÄöÁü•ÁªÑ‰ª∂ -->
  <div id="notification" class="notification">
    <span class="notification-icon">‚ÑπÔ∏è</span>
    <span class="notification-content"></span>
    <button class="notification-close">&times;</button>
  </div>

  <!-- Ê®°ÂûãÈÄâÊã©ÂºπÁ™ó -->
  <div id="model-select-modal" class="model-select-modal">
    <div class="model-select-title">ÈÄâÊã©Ê®°Âûã (Ctrl+Alt+T)</div>
    <div class="model-select-search">
      <input type="text" id="model-select-input" class="model-select-input" placeholder="ËæìÂÖ•Ê®°ÂûãÂêçÁß∞ÊêúÁ¥¢...">
    </div>
    <ul id="model-select-list" class="model-select-list">
      <!-- Ê®°ÂûãÂàóË°®Â∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
    </ul>
  </div>
  <div class="container">
    <!-- ‰æßËæπÊ†è -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h2>ËÅäÂ§©ËÆ∞ÂΩï</h2>
        <button id="new-chat-btn" class="button">Êñ∞ÂØπËØù</button>
      </div>
      <div class="sidebar-content">
        <ul id="chat-list" class="chat-list">
          <!-- ËÅäÂ§©ËÆ∞ÂΩïÂàóË°® -->
        </ul>
      </div>
      <div class="sidebar-footer">
        <button id="settings-btn" class="button button-secondary">Ê®°ÂûãËÆæÁΩÆ</button>
      </div>
    </div>

    <!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
    <div class="main-content">
      <div id="empty-state" class="empty-state">
        <div class="empty-state-icon">üí¨</div>
        <div class="empty-state-text">ÂºÄÂßã‰∏Ä‰∏™Êñ∞ÁöÑÂØπËØùÔºåÊàñ‰ªéÂ∑¶‰æßÈÄâÊã©ÂéÜÂè≤ËÆ∞ÂΩï</div>
        <button id="start-chat-btn" class="button">ÂºÄÂßãÊñ∞ÂØπËØù</button>
      </div>

      <div id="chat-container" style="display: none; flex-direction: column; height: 100%;">
        <div class="chat-header">
          <h2 id="chat-title">Êñ∞ÂØπËØù</h2>
          <div class="model-selector">
            <span>Ê®°Âûã:</span>
            <select id="model-select">
              <!-- Ê®°ÂûãÈÄâÈ°π -->
            </select>
          </div>
        </div>
        <div id="chat-messages" class="chat-messages">
          <!-- Ê∂àÊÅØÂÜÖÂÆπ -->
        </div>
        <div class="chat-input">
          <div class="input-container">
            <textarea id="message-input" class="message-input" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." rows="1"></textarea>
            <button id="send-button" class="send-button" disabled>‚û§</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ê®°ÂûãËÆæÁΩÆÂºπÁ™ó -->
  <div id="settings-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Ê®°ÂûãËÆæÁΩÆ</h3>
        <button class="close-button" id="close-settings">&times;</button>
      </div>
      <div class="form-group">
        <label for="model-name">Ê®°ÂûãÂêçÁß∞</label>
        <input type="text" id="model-name" placeholder="‰æãÂ¶Ç: GPT-3.5">
      </div>
      <div class="form-group">
        <label for="model-id">Ê®°ÂûãID</label>
        <input type="text" id="model-id" placeholder="‰æãÂ¶Ç: gpt-3.5-turbo">
      </div>
      <div class="form-group">
        <label for="api-url">APIÂú∞ÂùÄ</label>
        <input type="text" id="api-url" placeholder="‰æãÂ¶Ç: https://api.openai.com/v1/chat/completions">
      </div>
      <div class="form-group">
        <label for="api-key">APIÂØÜÈí•</label>
        <input type="password" id="api-key" placeholder="ËæìÂÖ•ÊÇ®ÁöÑAPIÂØÜÈí•">
      </div>
      <div class="form-group">
        <label for="system-prompt">Á≥ªÁªüÊèêÁ§∫ËØç</label>
        <textarea id="system-prompt" placeholder="ËæìÂÖ•Á≥ªÁªüÊèêÁ§∫ËØçÔºåÂÆö‰πâAIÂä©ÊâãÁöÑË°å‰∏∫ÂíåÁâπÊÄß">‰Ω†ÊòØ‰∏Ä‰∏™ÊúâÁî®ÁöÑAIÂä©ÊâãÔºåËÉΩÂ§üÂõûÁ≠îÁî®Êà∑ÁöÑÂêÑÁßçÈóÆÈ¢ò„ÄÇ</textarea>
      </div>
      <button id="add-model-btn" class="button">Ê∑ªÂä†Ê®°Âûã</button>

      <div class="model-list">
        <h4>Â∑≤Ê∑ªÂä†ÁöÑÊ®°Âûã</h4>
        <div id="model-list-container">
          <!-- Ê®°ÂûãÂàóË°® -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // Ëé∑ÂèñDOMÂÖÉÁ¥†
    const chatList = document.getElementById('chat-list');
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const newChatBtn = document.getElementById('new-chat-btn');
    const startChatBtn = document.getElementById('start-chat-btn');
    const settingsBtn = document.getElementById('settings-btn');
    const modelSelect = document.getElementById('model-select');
    const chatTitle = document.getElementById('chat-title');
    const emptyState = document.getElementById('empty-state');
    const chatContainer = document.getElementById('chat-container');
    
    // ÈÄöÁü•Áõ∏ÂÖ≥ÂÖÉÁ¥†
    const notification = document.getElementById('notification');
    const notificationContent = notification.querySelector('.notification-content');
    const notificationClose = notification.querySelector('.notification-close');
    
    // ËÆæÁΩÆÁõ∏ÂÖ≥ÂÖÉÁ¥†
    const settingsModal = document.getElementById('settings-modal');
    const closeSettings = document.getElementById('close-settings');
    const modelName = document.getElementById('model-name');
    const modelId = document.getElementById('model-id');
    const apiUrl = document.getElementById('api-url');
    const apiKey = document.getElementById('api-key');
    const systemPrompt = document.getElementById('system-prompt');
    const addModelBtn = document.getElementById('add-model-btn');
    const modelListContainer = document.getElementById('model-list-container');
    
    // Ê®°ÂûãÈÄâÊã©Áõ∏ÂÖ≥ÂÖÉÁ¥†
    const modelSelectModal = document.getElementById('model-select-modal');
    const modelSelectList = document.getElementById('model-select-list');
    const modelSelectInput = document.getElementById('model-select-input');
    
    // ÂΩìÂâç‰ºöËØùID
    let currentSessionId = null;
    // ÂΩìÂâç‰ºöËØùÊ∂àÊÅØ
    let currentMessages = [];
    // Ê®°ÂûãÈÖçÁΩÆÂàóË°®
    let modelConfigs = [];
    
    // Êõ¥Êñ∞Ê®°ÂûãÈÄâÊã©ÊåâÈíÆÊñáÊú¨
    function updateModelButtonText() {
      const selectedModelIndex = window.preload.dbUtil.getModelIndex() || 0;
      if (modelConfigs.length > 0 && selectedModelIndex < modelConfigs.length) {
        const selectedModel = modelConfigs[selectedModelIndex];
        modelSelect.value = selectedModelIndex;
        modelSelect.selectedIndex = selectedModelIndex;
      }
    }
    
    // ÂàùÂßãÂåñ
    function init() {
      // Âä†ËΩΩÊ®°ÂûãÈÖçÁΩÆ
      loadModelConfigs();
      // Âä†ËΩΩËÅäÂ§©ËÆ∞ÂΩï
      loadChatSessions();
      // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨
      setupEventListeners();
      // ÈÖçÁΩÆMarkdownÊ∏≤ÊüìÂô®
      configureMarkdown();
    }
    
    // ÈÖçÁΩÆMarkdownÊ∏≤ÊüìÂô®
    function configureMarkdown() {
      marked.setOptions({
        highlight: function(code, lang) {
          const language = hljs.getLanguage(lang) ? lang : 'plaintext';
          return hljs.highlight(code, { language }).value;
        },
        langPrefix: 'hljs language-',
        gfm: true,
        breaks: true
      });
    }
    
    // Âä†ËΩΩÊ®°ÂûãÈÖçÁΩÆ
    function loadModelConfigs() {
      modelConfigs = window.preload.dbUtil.getModelConfig() || [];
      console.log('Âä†ËΩΩÁöÑÊ®°ÂûãÈÖçÁΩÆ:', modelConfigs); // Ê∑ªÂä†Ë∞ÉËØïÊó•Âøó
      
      // Á°Æ‰øùÊØè‰∏™Ê®°ÂûãÈÖçÁΩÆÈÉΩÊúâÂøÖË¶ÅÁöÑÂ≠óÊÆµ
      modelConfigs = modelConfigs.map(config => ({
        name: config.name || 'Êú™ÂëΩÂêçÊ®°Âûã',
        model: config.model || 'gpt-3.5-turbo',
        url: config.url || 'https://api.openai.com/v1/chat/completions',
        key: config.key || '',
        systemPrompt: config.systemPrompt || '‰Ω†ÊòØ‰∏Ä‰∏™ÊúâÁî®ÁöÑAIÂä©ÊâãÔºåËÉΩÂ§üÂõûÁ≠îÁî®Êà∑ÁöÑÂêÑÁßçÈóÆÈ¢ò„ÄÇ'
      }));
      
      updateModelSelect();
      updateModelList();
    }
    
    // Êõ¥Êñ∞Ê®°ÂûãÈÄâÊã©‰∏ãÊãâÊ°Ü
    function updateModelSelect() {
      modelSelect.innerHTML = '';
      
      if (modelConfigs.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'ËØ∑ÂÖàÊ∑ªÂä†Ê®°Âûã';
        modelSelect.appendChild(option);
        modelSelect.disabled = true;
      } else {
        modelSelect.disabled = false;
        modelConfigs.forEach((config, index) => {
          const option = document.createElement('option');
          option.value = index;
          option.textContent = config.name;
          modelSelect.appendChild(option);
        });
      }
    }
    
    // Êõ¥Êñ∞Ê®°ÂûãÂàóË°®
    function updateModelList() {
      modelListContainer.innerHTML = '';
      
      if (modelConfigs.length === 0) {
        modelListContainer.innerHTML = '<p>ÊöÇÊó†Ê®°ÂûãÔºåËØ∑Ê∑ªÂä†</p>';
        return;
      }
      
      modelConfigs.forEach((config, index) => {
        const modelItem = document.createElement('div');
        modelItem.className = 'model-item';
        
        const modelInfo = document.createElement('div');
        modelInfo.className = 'model-item-info';
        
        const modelItemName = document.createElement('div');
        modelItemName.className = 'model-item-name';
        modelItemName.textContent = config.name;
        
        const modelItemUrl = document.createElement('div');
        modelItemUrl.className = 'model-item-url';
        modelItemUrl.textContent = `${config.url} (${config.model})`;
        
        const modelItemPrompt = document.createElement('div');
        modelItemPrompt.className = 'model-item-url';
        modelItemPrompt.textContent = `Á≥ªÁªüÊèêÁ§∫ËØç: ${config.systemPrompt ? (config.systemPrompt.substring(0, 30) + '...') : 'Êó†'}`;
        
        modelInfo.appendChild(modelItemName);
        modelInfo.appendChild(modelItemUrl);
        modelInfo.appendChild(modelItemPrompt);
        
        const modelActions = document.createElement('div');
        modelActions.className = 'model-item-actions';
        
        const editBtn = document.createElement('button');
        editBtn.className = 'button';
        editBtn.textContent = 'ÁºñËæë';
        editBtn.onclick = () => editModel(index);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'button button-secondary';
        deleteBtn.textContent = 'Âà†Èô§';
        deleteBtn.onclick = () => deleteModel(index);
        
        modelActions.appendChild(editBtn);
        modelActions.appendChild(deleteBtn);
        
        modelItem.appendChild(modelInfo);
        modelItem.appendChild(modelActions);
        
        modelListContainer.appendChild(modelItem);
      });
    }
    
    // ÁºñËæëÊ®°Âûã
    function editModel(index) {
      const config = modelConfigs[index];
      modelName.value = config.name;
      modelId.value = config.model;
      apiUrl.value = config.url;
      apiKey.value = config.key;
      systemPrompt.value = config.systemPrompt || '‰Ω†ÊòØ‰∏Ä‰∏™ÊúâÁî®ÁöÑAIÂä©ÊâãÔºåËÉΩÂ§üÂõûÁ≠îÁî®Êà∑ÁöÑÂêÑÁßçÈóÆÈ¢ò„ÄÇ';
      
      // Âà†Èô§ÂéüÊ®°Âûã
      modelConfigs.splice(index, 1);
      
      // Êõ¥Êñ∞UI
      updateModelSelect();
      updateModelList();
    }
    
    // Âä†ËΩΩËÅäÂ§©ËÆ∞ÂΩï
    function loadChatSessions() {
      const sessions = window.preload.dbUtil.getAllSessions();
      
      chatList.innerHTML = '';
      
      if (sessions.length === 0) {
        return;
      }
      
      sessions.forEach(session => {
        addChatItemToList(session);
      });
    }
    
    // Ê∑ªÂä†ËÅäÂ§©È°πÂà∞ÂàóË°®
    function addChatItemToList(session) {
      const chatItem = document.createElement('li');
      chatItem.className = 'chat-item';
      chatItem.dataset.id = session.id;
      
      if (currentSessionId === session.id) {
        chatItem.classList.add('active');
      }
      
      const lastMessage = session.messages[session.messages.length - 1];
      const title = session.messages[0]?.content.substring(0, 20) || 'Êñ∞ÂØπËØù';
      const preview = lastMessage ? `${lastMessage.role === 'user' ? '‰Ω†: ' : 'AI: '}${lastMessage.content.substring(0, 30)}` : '';
      
      chatItem.innerHTML = `
        <div class="chat-item-content">
          <div class="chat-item-title">${title}</div>
          <div class="chat-item-preview">${preview}</div>
        </div>
        <div class="chat-item-delete" title="Âà†Èô§ÂØπËØù">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 6h18"></path>
            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
            <line x1="10" y1="11" x2="10" y2="17"></line>
            <line x1="14" y1="11" x2="14" y2="17"></line>
          </svg>
        </div>
      `;
      
      chatItem.addEventListener('click', (e) => {
        // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÂà†Èô§ÊåâÈíÆÔºå‰∏çËß¶ÂèëÂä†ËΩΩÂØπËØù
        if (e.target.closest('.chat-item-delete')) {
          e.stopPropagation();
          deleteChatSession(session.id);
          return;
        }
        loadChatSession(session.id);
      });
      
      chatList.appendChild(chatItem);
    }
    
    // Âä†ËΩΩËÅäÂ§©‰ºöËØù
    function loadChatSession(sessionId) {
      currentSessionId = sessionId;
      currentMessages = window.preload.dbUtil.getChatHistory(sessionId) || [];
      
      // Êõ¥Êñ∞UI
      updateChatUI();
      
      // Êõ¥Êñ∞Ê¥ªÂä®Áä∂ÊÄÅ
      document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.id === sessionId) {
          item.classList.add('active');
        }
      });
    }
    
    // ÂàõÂª∫Êñ∞‰ºöËØù
    function createNewChat() {
      currentSessionId = Date.now().toString();
      currentMessages = [];
      
      // Êõ¥Êñ∞UI
      updateChatUI();
      
      // Ê∑ªÂä†Âà∞ÂàóË°®
      const session = {
        id: currentSessionId,
        messages: currentMessages,
        lastTime: Date.now()
      };
      
      addChatItemToList(session);
      
      // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
      window.preload.dbUtil.saveChatHistory(currentSessionId, currentMessages);
    }
    
    // Êõ¥Êñ∞ËÅäÂ§©UI
    function updateChatUI() {
      if (currentSessionId === null) {
        emptyState.style.display = 'flex';
        chatContainer.style.display = 'none';
        return;
      }
      
      emptyState.style.display = 'none';
      chatContainer.style.display = 'flex';
      
      // Êõ¥Êñ∞Ê†áÈ¢ò
      if (currentMessages.length > 0) {
        chatTitle.textContent = currentMessages[0].content.substring(0, 20);
      } else {
        chatTitle.textContent = 'Êñ∞ÂØπËØù';
      }
      
      // Êõ¥Êñ∞Ê∂àÊÅØÂàóË°®
      renderMessages();
    }
    
    // Ê∏≤ÊüìÊ∂àÊÅØ
    function renderMessages() {
      chatMessages.innerHTML = '';
      
      currentMessages.forEach(msg => {
        const messageEl = document.createElement('div');
        messageEl.className = `message message-${msg.role === 'user' ? 'user' : 'ai'}`;
        
        const messageContent = document.createElement('div');
        
        // ‰ΩøÁî®MarkdownÊ∏≤ÊüìAIÊ∂àÊÅØ
        if (msg.role === 'assistant') {
          messageContent.className = 'markdown-content';
          messageContent.innerHTML = marked.parse(msg.content);
          // È´ò‰∫Æ‰ª£Á†ÅÂùó
          messageEl.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightElement(block);
          });
        } else {
          messageContent.textContent = msg.content;
        }
        
        const messageTime = document.createElement('div');
        messageTime.className = 'message-time';
        messageTime.textContent = formatTime(msg.timestamp);
        
        messageEl.appendChild(messageContent);
        messageEl.appendChild(messageTime);
        
        chatMessages.appendChild(messageEl);
      });
      
      // ÊªöÂä®Âà∞Â∫ïÈÉ®
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Ê†ºÂºèÂåñÊó∂Èó¥
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
    }
    
    // ÂèëÈÄÅÊ∂àÊÅØ
    async function sendMessage() {
      const message = messageInput.value.trim();
      if (!message) return;
      
      // Â¶ÇÊûúÊ≤°ÊúâÂΩìÂâç‰ºöËØùÔºåÂàõÂª∫‰∏Ä‰∏™Êñ∞‰ºöËØù
      if (currentSessionId === null) {
        createNewChat();
      }
      
      // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
      const userMessage = {
        role: 'user',
        content: message,
        timestamp: Date.now()
      };
      
      currentMessages.push(userMessage);
      
      // Êõ¥Êñ∞UI
      messageInput.value = '';
      renderMessages();
      
      // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
      window.preload.dbUtil.saveChatHistory(currentSessionId, currentMessages);
      
      // Êõ¥Êñ∞ËÅäÂ§©ÂàóË°®
      loadChatSessions();
      
      // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÊ®°Âûã
      const selectedModelIndex = modelSelect.value;
      if (selectedModelIndex === '' || modelConfigs.length === 0) {
        alert('ËØ∑ÂÖàÊ∑ªÂä†Ê®°ÂûãÈÖçÁΩÆ');
        return;
      }
      
      const modelConfig = modelConfigs[selectedModelIndex];
      
      // ÂáÜÂ§áÂèëÈÄÅÁªôAIÁöÑÊ∂àÊÅØ
      const aiMessages = [];
      
      // Ê∑ªÂä†Á≥ªÁªüÊèêÁ§∫ËØç
      if (modelConfig.systemPrompt) {
        aiMessages.push({
          role: 'system',
          content: modelConfig.systemPrompt
        });
      }
      
      // Ê∑ªÂä†ÂØπËØùÂéÜÂè≤
      currentMessages.forEach(msg => {
        if (msg.role !== 'system') {
          aiMessages.push({
            role: msg.role,
            content: msg.content
          });
        }
      });
      
      try {
        // Ê∑ªÂä†AIÂõûÂ§çÂç†‰Ωç
        const aiMessage = {
          role: 'assistant',
          content: '',
          timestamp: Date.now()
        };
        
        currentMessages.push(aiMessage);
        renderMessages();
        
        // Ë∞ÉÁî®AI APIÂπ∂Â§ÑÁêÜÊµÅÂºèËæìÂá∫
        await window.preload.aiUtil.callAI(modelConfig, aiMessages, (content) => {
          aiMessage.content = content;
          renderMessages();
        });
        
        // Êõ¥Êñ∞UIÂíå‰øùÂ≠òÊï∞ÊçÆ
        
        // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
        window.preload.dbUtil.saveChatHistory(currentSessionId, currentMessages);
        
        // Êõ¥Êñ∞ËÅäÂ§©ÂàóË°®
        loadChatSessions();
      } catch (error) {
        console.error('ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•:', error);
        
        // ÁßªÈô§Âä†ËΩΩ‰∏≠Ê∂àÊÅØ
        currentMessages.pop();
        
        // Ê∑ªÂä†ÈîôËØØÊ∂àÊÅØ
        const errorMessage = {
          role: 'assistant',
          content: `ÂèëÁîüÈîôËØØ: ${error.message}`,
          timestamp: Date.now()
        };
        
        currentMessages.push(errorMessage);
        
        // Êõ¥Êñ∞UI
        renderMessages();
        
        // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
        window.preload.dbUtil.saveChatHistory(currentSessionId, currentMessages);
      }
    }
    
    // Ê∑ªÂä†Ê®°Âûã
    function addModel() {
      const name = modelName.value.trim();
      const model = modelId.value.trim();
      const url = apiUrl.value.trim();
      const key = apiKey.value.trim();
      const prompt = systemPrompt.value.trim();
      
      if (!name || !model || !url || !key) {
        alert('ËØ∑Â°´ÂÜôÊâÄÊúâÂøÖÂ°´Â≠óÊÆµ');
        return;
      }
      
      const newModel = { 
        name, 
        model, 
        url, 
        key,
        systemPrompt: prompt
      };
      
      modelConfigs.push(newModel);
      
      // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
      window.preload.dbUtil.saveModelConfig(modelConfigs);
      
      // Êõ¥Êñ∞UI
      updateModelSelect();
      updateModelList();
      
      // Ê∏ÖÁ©∫Ë°®Âçï
      modelName.value = '';
      modelId.value = '';
      apiUrl.value = '';
      apiKey.value = '';
      systemPrompt.value = '‰Ω†ÊòØ‰∏Ä‰∏™ÊúâÁî®ÁöÑAIÂä©ÊâãÔºåËÉΩÂ§üÂõûÁ≠îÁî®Êà∑ÁöÑÂêÑÁßçÈóÆÈ¢ò„ÄÇ';
    }
    
    // Âà†Èô§Ê®°Âûã
    function deleteModel(index) {
      if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Ê®°ÂûãÂêóÔºü')) {
        modelConfigs.splice(index, 1);
        
        // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
        window.preload.dbUtil.saveModelConfig(modelConfigs);
        
        // Êõ¥Êñ∞UI
        updateModelSelect();
        updateModelList();
      }
    }
    
    // Âà†Èô§ËÅäÂ§©‰ºöËØù
    function deleteChatSession(sessionId) {
      // ‰ªéÊï∞ÊçÆÂ∫ì‰∏≠Âà†Èô§
      window.preload.dbUtil.deleteChatHistory(sessionId);
      
      // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâç‰ºöËØùÔºåÊ∏ÖÁ©∫ÂΩìÂâç‰ºöËØù
      if (currentSessionId === sessionId) {
        currentSessionId = null;
        currentMessages = [];
        updateChatUI();
      }
      
      // ÈáçÊñ∞Âä†ËΩΩËÅäÂ§©ÂàóË°®
      loadChatSessions();
      
      // ÊòæÁ§∫Âà†Èô§ÊàêÂäüÈÄöÁü•
      showNotification('ÂØπËØùÂ∑≤Âà†Èô§', 'success');
    }
    
    // ÊòæÁ§∫ÈÄöÁü•
    function showNotification(message, type = 'info', duration = 3000) {
      // ËÆæÁΩÆÈÄöÁü•ÂÜÖÂÆπÂíåÁ±ªÂûã
      notificationContent.textContent = message;
      notification.className = `notification ${type}`;
      
      // ÊòæÁ§∫ÈÄöÁü•
      notification.classList.add('show');
      
      // ËÆæÁΩÆËá™Âä®ÂÖ≥Èó≠
      setTimeout(() => {
        hideNotification();
      }, duration);
    }
    
    // ÈöêËóèÈÄöÁü•
    function hideNotification() {
      notification.classList.remove('show');
    }
    
    // ËÆæÁΩÆÈÄöÁü•ÂÖ≥Èó≠ÊåâÈíÆ‰∫ã‰ª∂
    notificationClose.addEventListener('click', hideNotification);
    
    // ÊòæÁ§∫Ê®°ÂûãÈÄâÊã©ÂºπÁ™ó
    function showModelSelectModal() {
      if (modelConfigs.length === 0) {
        showNotification('ËØ∑ÂÖàÊ∑ªÂä†Ê®°ÂûãÈÖçÁΩÆ', 'warning');
        return;
      }
      
      // ÁîüÊàêÊ®°ÂûãÂàóË°®
      modelSelectList.innerHTML = '';
      let activeIndex = parseInt(modelSelect.value) || 0;
      
      // ÊòæÁ§∫ÊâÄÊúâÊ®°Âûã
      updateModelListItems(modelConfigs, activeIndex);
      
      // ÊòæÁ§∫ÂºπÁ™ó
      modelSelectModal.classList.add('show');
      
      // ËÅöÁÑ¶Âà∞ÊêúÁ¥¢Ê°Ü
      modelSelectInput.focus();
      
      // ÁõëÂê¨ÈîÆÁõò‰∫ã‰ª∂
      document.addEventListener('keydown', handleModelSelectKeydown);
    }
    
    // Êõ¥Êñ∞Ê®°ÂûãÂàóË°®È°π
    function updateModelListItems(models, activeIndex = 0) {
      modelSelectList.innerHTML = '';
      
      models.forEach((model, index) => {
        const item = document.createElement('li');
        item.className = 'model-select-item';
        if (index === activeIndex) {
          item.classList.add('active');
        }
        
        item.innerHTML = `
          <div class="model-select-name">${model.name}</div>
          <div class="model-select-shortcut">${index + 1}</div>
        `;
        
        item.addEventListener('click', () => {
          selectModel(index);
        });
        
        modelSelectList.appendChild(item);
      });
    }
    
    // Â§ÑÁêÜÊ®°ÂûãÈÄâÊã©ÈîÆÁõò‰∫ã‰ª∂
    function handleModelSelectKeydown(e) {
      const items = modelSelectList.querySelectorAll('.model-select-item');
      const activeItem = modelSelectList.querySelector('.model-select-item.active');
      let activeIndex = Array.from(items).indexOf(activeItem);
      
      // Â¶ÇÊûúÊ≠£Âú®ËæìÂÖ•ÊêúÁ¥¢ÂÜÖÂÆπÔºå‰∏çÂ§ÑÁêÜÂÖ∂‰ªñÊåâÈîÆ
      if (e.target === modelSelectInput) {
        if (e.key === 'Enter') {
          e.preventDefault();
          if (activeItem) {
            const index = Array.from(items).indexOf(activeItem);
            selectModel(index);
          }
        }
        return;
      }
      
      switch (e.key) {
        case 'Escape':
          hideModelSelectModal();
          break;
          
        case 'ArrowUp':
          e.preventDefault();
          if (activeIndex > 0) {
            activeItem.classList.remove('active');
            items[activeIndex - 1].classList.add('active');
            items[activeIndex - 1].scrollIntoView({ block: 'nearest' });
          }
          break;
          
        case 'ArrowDown':
          e.preventDefault();
          if (activeIndex < items.length - 1) {
            activeItem.classList.remove('active');
            items[activeIndex + 1].classList.add('active');
            items[activeIndex + 1].scrollIntoView({ block: 'nearest' });
          }
          break;
          
        case 'Enter':
          e.preventDefault();
          if (activeItem) {
            const index = Array.from(items).indexOf(activeItem);
            selectModel(index);
          }
          break;
          
        default:
          // Êï∞Â≠óÈîÆÈÄâÊã©ÔºàÂèØÈÄâÔºâ
          const number = parseInt(e.key);
          if (!isNaN(number) && number >= 1 && number <= modelConfigs.length) {
            selectModel(number - 1);
          }
      }
    }
    
    // ÊêúÁ¥¢Ê®°Âûã
    function searchModels(query) {
      const filteredModels = modelConfigs.filter(model => 
        model.name.toLowerCase().includes(query.toLowerCase())
      );
      
      updateModelListItems(filteredModels);
      
      // Â¶ÇÊûúÊúâÂåπÈÖçÈ°πÔºåÈÄâ‰∏≠Á¨¨‰∏Ä‰∏™
      if (filteredModels.length > 0) {
        const firstItem = modelSelectList.querySelector('.model-select-item');
        if (firstItem) {
          firstItem.classList.add('active');
        }
      }
    }
    
    // ÈÄâÊã©Ê®°Âûã
    function selectModel(index) {
      // Ëé∑ÂèñÂΩìÂâçÊòæÁ§∫ÁöÑÊ®°ÂûãÂàóË°®
      const displayedItems = modelSelectList.querySelectorAll('.model-select-item');
      if (index >= 0 && index < displayedItems.length) {
        // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÊ®°ÂûãÂêçÁß∞
        const selectedModelName = displayedItems[index].querySelector('.model-select-name').textContent;
        
        // Âú®ÂéüÂßãÊ®°ÂûãÈÖçÁΩÆ‰∏≠ÊâæÂà∞ÂØπÂ∫îÁöÑÁ¥¢Âºï
        const originalIndex = modelConfigs.findIndex(model => model.name === selectedModelName);
        
        if (originalIndex !== -1) {
          // Êõ¥Êñ∞‰∏ãÊãâÊ°ÜÁöÑÂÄºÂíåÊòæÁ§∫ÊñáÊú¨
          modelSelect.value = originalIndex;
          modelSelect.selectedIndex = originalIndex;
          
          // Êõ¥Êñ∞ÂΩìÂâçÈÄâ‰∏≠ÁöÑÊ®°ÂûãÈÖçÁΩÆ
          const selectedModel = modelConfigs[originalIndex];
          
          // ‰øùÂ≠òÂΩìÂâçÈÄâÊã©ÁöÑÊ®°ÂûãÁ¥¢Âºï
          window.preload.dbUtil.saveModelConfig(modelConfigs);
          window.preload.dbUtil.saveModelIndex(originalIndex);
          
          // ÈöêËóèÂºπÁ™ó
          hideModelSelectModal();
          
          // ÊòæÁ§∫ÈÄöÁü•
          showNotification(`Â∑≤ÂàáÊç¢Âà∞Ê®°Âûã: ${selectedModel.name}`, 'success');
          
          // Ê∏ÖÁ©∫ÊêúÁ¥¢Ê°Ü
          modelSelectInput.value = '';
        }
      }
    }
    
    // ÈöêËóèÊ®°ÂûãÈÄâÊã©ÂºπÁ™ó
    function hideModelSelectModal() {
      modelSelectModal.classList.remove('show');
      document.removeEventListener('keydown', handleModelSelectKeydown);
    }
    
    // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨
    function setupEventListeners() {
      // ÂèëÈÄÅÊ∂àÊÅØ
      sendButton.addEventListener('click', sendMessage);
      
      // ÊåâEnterÂèëÈÄÅÊ∂àÊÅØ
      messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      
      // ËæìÂÖ•Ê°ÜÂÜÖÂÆπÂèòÂåñ
      messageInput.addEventListener('input', () => {
        sendButton.disabled = messageInput.value.trim() === '';
      });
      
      // Êñ∞Âª∫ËÅäÂ§©
      newChatBtn.addEventListener('click', createNewChat);
      startChatBtn.addEventListener('click', createNewChat);
      
      // ËÆæÁΩÆÊåâÈíÆ
      settingsBtn.addEventListener('click', () => {
        settingsModal.classList.add('active');
      });
      
      // ÂÖ≥Èó≠ËÆæÁΩÆ
      closeSettings.addEventListener('click', () => {
        settingsModal.classList.remove('active');
      });
      
      // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
      settingsModal.addEventListener('click', (e) => {
        if (e.target === settingsModal) {
          settingsModal.classList.remove('active');
        }
      });
      
      // Ê∑ªÂä†Ê®°Âûã
      addModelBtn.addEventListener('click', addModel);
      
      // ÁõëÂê¨Âø´Êç∑ÈîÆ
      document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.altKey && e.key.toLowerCase() === 't') {
          e.preventDefault();
          showModelSelectModal();
        }
      });
      
      // ÁÇπÂáªÂºπÁ™óÂ§ñÈÉ®ÂÖ≥Èó≠
      modelSelectModal.addEventListener('click', (e) => {
        if (e.target === modelSelectModal) {
          hideModelSelectModal();
        }
      });
      
      // ÊêúÁ¥¢Ê°ÜËæìÂÖ•‰∫ã‰ª∂
      modelSelectInput.addEventListener('input', (e) => {
        searchModels(e.target.value);
      });
      
      // ÊêúÁ¥¢Ê°ÜÈîÆÁõò‰∫ã‰ª∂
      modelSelectInput.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          const firstItem = modelSelectList.querySelector('.model-select-item');
          if (firstItem) {
            firstItem.classList.add('active');
            firstItem.scrollIntoView({ block: 'nearest' });
          }
        }
      });
    }
    
    // ÂàùÂßãÂåñÂ∫îÁî®
    document.addEventListener('DOMContentLoaded', () => {
      // Ëé∑Âèñ‰øùÂ≠òÁöÑÊ®°ÂûãÈÖçÁΩÆ
      const savedModelConfigs = window.preload.dbUtil.getModelConfig()
      if (savedModelConfigs && savedModelConfigs.length > 0) {
        modelConfigs = savedModelConfigs
      }
      
      // Ëé∑Âèñ‰øùÂ≠òÁöÑÊ®°ÂûãÁ¥¢Âºï
      const savedModelIndex = window.preload.dbUtil.getModelIndex()
      if (savedModelIndex !== undefined) {
        currentSessionId = savedModelIndex
        updateModelButtonText()
      }
      
      // ÂàùÂßãÂåñÂÖ∂‰ªñUIÂÖÉÁ¥†
      init()
    });
  </script>
</body>
</html>
