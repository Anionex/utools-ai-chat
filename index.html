<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIèŠå¤©åŠ©æ‰‹</title>
  <!-- å¼•å…¥Markdownæ¸²æŸ“åº“ -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/highlight.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: #f8f9fa;
      color: #333;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    .sidebar {
      width: 250px;
      background-color: #2d2d2d;
      color: #f8f9fa;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #444;
    }
    .sidebar-header {
      padding: 15px;
      border-bottom: 1px solid #444;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .sidebar-content {
      flex: 1;
      overflow-y: auto;
    }
    .chat-list {
      list-style: none;
    }
    .chat-item {
      padding: 12px 15px;
      cursor: pointer;
      border-bottom: 1px solid #444;
      transition: background-color 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-item:hover {
      background-color: #3d3d3d;
    }
    .chat-item.active {
      background-color: #4d4d4d;
      border-left: 3px solid #e0e0e0;
    }
    .chat-item-content {
      flex: 1;
      overflow: hidden;
    }
    .chat-item-title {
      font-weight: 500;
      margin-bottom: 5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .chat-item-preview {
      font-size: 12px;
      color: #aaa;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .chat-item-delete {
      width: 20px;
      height: 20px;
      opacity: 0;
      transition: opacity 0.2s;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
    }
    .chat-item:hover .chat-item-delete {
      opacity: 1;
    }
    .chat-item-delete:hover {
      color: #ff4444;
    }
    .sidebar-footer {
      padding: 15px;
      border-top: 1px solid #444;
    }
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: #fff;
    }
    .chat-header {
      padding: 15px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #f8f9fa;
    }
    .model-selector {
      display: flex;
      align-items: center;
    }
    .model-selector select {
      margin-left: 10px;
      padding: 5px;
      border-radius: 4px;
      border: 1px solid #ddd;
      background-color: #fff;
    }
    .chat-messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      background-color: #f8f9fa;
    }
    .message {
      max-width: 80%;
      margin-bottom: 15px;
      padding: 10px 15px;
      border-radius: 18px;
      position: relative;
      line-height: 1.5;
    }
    .message-user {
      align-self: flex-end;
      background-color: #e0e0e0;
      color: #333;
      border-bottom-right-radius: 5px;
    }
    .message-ai {
      align-self: flex-start;
      background-color: #f1f1f1;
      color: #333;
      border-bottom-left-radius: 5px;
    }
    .message-time {
      font-size: 10px;
      color: #999;
      margin-top: 5px;
      text-align: right;
    }
    .chat-input {
      padding: 15px;
      border-top: 1px solid #eee;
      background-color: #f8f9fa;
    }
    .input-container {
      display: flex;
      position: relative;
    }
    .message-input {
      flex: 1;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 24px;
      outline: none;
      resize: none;
      max-height: 120px;
      overflow-y: auto;
      background-color: #fff;
    }
    .send-button {
      margin-left: 10px;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background-color: #666;
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
    }
    .send-button:hover {
      background-color: #888;
    }
    .send-button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .button {
      padding: 8px 12px;
      background-color: #666;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .button:hover {
      background-color: #888;
    }
    .button-secondary {
      background-color: #555;
    }
    .button-secondary:hover {
      background-color: #777;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      width: 500px;
      max-width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .modal-title {
      font-size: 18px;
      font-weight: 500;
    }
    .close-button {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #999;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #fff;
    }
    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }
    .model-list {
      margin-top: 20px;
      border-top: 1px solid #ddd;
      padding-top: 15px;
    }
    .model-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    .model-item-info {
      flex: 1;
    }
    .model-item-name {
      font-weight: 500;
    }
    .model-item-url {
      font-size: 12px;
      color: #999;
    }
    .model-item-actions {
      display: flex;
      gap: 5px;
    }
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #999;
      text-align: center;
      padding: 20px;
      background-color: #f8f9fa;
    }
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    .empty-state-text {
      margin-bottom: 20px;
    }
    /* Markdownæ ·å¼ */
    .markdown-content {
      line-height: 1.6;
    }
    .markdown-content h1, .markdown-content h2, .markdown-content h3, 
    .markdown-content h4, .markdown-content h5, .markdown-content h6 {
      margin-top: 1em;
      margin-bottom: 0.5em;
    }
    .markdown-content p {
      margin-bottom: 1em;
    }
    .markdown-content ul, .markdown-content ol {
      margin-bottom: 1em;
      padding-left: 2em;
    }
    .markdown-content pre {
      background-color: #f0f0f0;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      margin-bottom: 1em;
    }
    .markdown-content code {
      background-color: #f0f0f0;
      padding: 2px 4px;
      border-radius: 3px;
      font-family: monospace;
    }
    .markdown-content pre code {
      padding: 0;
      background-color: transparent;
    }
    .markdown-content blockquote {
      border-left: 4px solid #ddd;
      padding-left: 1em;
      margin-left: 0;
      margin-bottom: 1em;
      color: #666;
    }
    .markdown-content table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 1em;
    }
    .markdown-content table th, .markdown-content table td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    .markdown-content table th {
      background-color: #f0f0f0;
      text-align: left;
    }
    .markdown-content img {
      max-width: 100%;
      height: auto;
    }
    /* æš—è‰²ä¸»é¢˜ä»£ç é«˜äº® */
    .hljs {
      background: #282c34;
      color: #abb2bf;
      border-radius: 4px;
    }
    /* é€šçŸ¥ç»„ä»¶æ ·å¼ */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      background-color: #2d2d2d;
      color: #fff;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      gap: 10px;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.3s ease;
      z-index: 1000;
    }
    .notification.show {
      opacity: 1;
      transform: translateX(0);
    }
    .notification.success {
      background-color: #4caf50;
    }
    .notification.error {
      background-color: #f44336;
    }
    .notification.warning {
      background-color: #ff9800;
    }
    .notification-icon {
      font-size: 20px;
    }
    .notification-content {
      flex: 1;
    }
    .notification-close {
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      padding: 0;
      font-size: 16px;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    .notification-close:hover {
      opacity: 1;
    }
    /* æ¨¡å‹é€‰æ‹©å¼¹çª—æ ·å¼ */
    .model-select-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #2d2d2d;
      color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      padding: 20px;
      min-width: 400px;
      max-width: 600px;
      z-index: 1001;
      display: none;
    }
    .model-select-modal.show {
      display: block;
    }
    .model-select-title {
      font-size: 14px;
      color: #999;
      margin-bottom: 10px;
      padding: 0 10px;
    }
    .model-select-search {
      margin-bottom: 10px;
    }
    .model-select-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .model-select-list {
      list-style: none;
      margin: 0;
      padding: 0;
      max-height: 300px;
      overflow-y: auto;
    }
    .model-select-item {
      padding: 8px 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background-color 0.2s;
      border-radius: 4px;
      margin: 2px 0;
    }
    .model-select-item:hover {
      background-color: #3d3d3d;
    }
    .model-select-item.active {
      background-color: #4d4d4d;
    }
    .model-select-name {
      flex: 1;
      font-size: 14px;
    }
    .model-select-shortcut {
      color: #999;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .model-select-item:hover .model-select-shortcut {
      opacity: 1;
    }
    /* æ»šåŠ¨æ¡æ ·å¼ */
    .model-select-list::-webkit-scrollbar {
      width: 8px;
    }
    .model-select-list::-webkit-scrollbar-track {
      background: #2d2d2d;
    }
    .model-select-list::-webkit-scrollbar-thumb {
      background: #4d4d4d;
      border-radius: 4px;
    }
    .model-select-list::-webkit-scrollbar-thumb:hover {
      background: #5d5d5d;
    }
    /* ç¡®è®¤å¯¹è¯æ¡†æ ·å¼ */
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    .modal-body {
      padding: 15px 0;
    }
  </style>
</head>
<body>
  <!-- é€šçŸ¥ç»„ä»¶ -->
  <div id="notification" class="notification">
    <span class="notification-icon">â„¹ï¸</span>
    <span class="notification-content"></span>
    <button class="notification-close">&times;</button>
  </div>

  <!-- æ¨¡å‹é€‰æ‹©å¼¹çª— -->
  <div id="model-select-modal" class="model-select-modal">
    <div class="model-select-title">é€‰æ‹©æ¨¡å‹ (Ctrl+Alt+T)</div>
    <div class="model-select-search">
      <input type="text" id="model-select-input" class="model-select-input" placeholder="è¾“å…¥æ¨¡å‹åç§°æœç´¢...">
    </div>
    <ul id="model-select-list" class="model-select-list">
      <!-- æ¨¡å‹åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
    </ul>
  </div>
  <div class="container">
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h2>èŠå¤©è®°å½•</h2>
        <button id="new-chat-btn" class="button">æ–°å¯¹è¯</button>
      </div>
      <div class="sidebar-content">
        <ul id="chat-list" class="chat-list">
          <!-- èŠå¤©è®°å½•åˆ—è¡¨ -->
        </ul>
      </div>
      <div class="sidebar-footer">
        <button id="settings-btn" class="button button-secondary">æ¨¡å‹è®¾ç½®</button>
      </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content">
      <div id="empty-state" class="empty-state">
        <div class="empty-state-icon">ğŸ’¬</div>
        <div class="empty-state-text">å¼€å§‹ä¸€ä¸ªæ–°çš„å¯¹è¯ï¼Œæˆ–ä»å·¦ä¾§é€‰æ‹©å†å²è®°å½•</div>
        <button id="start-chat-btn" class="button">å¼€å§‹æ–°å¯¹è¯</button>
      </div>

      <div id="chat-container" style="display: none; flex-direction: column; height: 100%;">
        <div class="chat-header">
          <h2 id="chat-title">æ–°å¯¹è¯</h2>
          <div class="model-selector">
            <span>æ¨¡å‹:</span>
            <select id="model-select">
              <!-- æ¨¡å‹é€‰é¡¹ -->
            </select>
          </div>
        </div>
        <div id="chat-messages" class="chat-messages">
          <!-- æ¶ˆæ¯å†…å®¹ -->
        </div>
        <div class="chat-input">
          <div class="input-container">
            <textarea id="message-input" class="message-input" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1"></textarea>
            <button id="send-button" class="send-button" disabled>â¤</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- æ¨¡å‹è®¾ç½®å¼¹çª— -->
  <div id="settings-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">æ¨¡å‹è®¾ç½®</h3>
        <button class="close-button" id="close-settings">&times;</button>
      </div>
      <div class="form-group">
        <label for="model-name">æ¨¡å‹åç§°</label>
        <input type="text" id="model-name" placeholder="ä¾‹å¦‚: GPT-3.5">
      </div>
      <div class="form-group">
        <label for="model-id">æ¨¡å‹ID</label>
        <input type="text" id="model-id" placeholder="ä¾‹å¦‚: gpt-3.5-turbo">
      </div>
      <div class="form-group">
        <label for="api-url">APIåœ°å€</label>
        <input type="text" id="api-url" placeholder="ä¾‹å¦‚: https://api.openai.com/v1/chat/completions">
      </div>
      <div class="form-group">
        <label for="api-key">APIå¯†é’¥</label>
        <input type="password" id="api-key" placeholder="è¾“å…¥æ‚¨çš„APIå¯†é’¥">
      </div>
      <div class="form-group">
        <label for="system-prompt">ç³»ç»Ÿæç¤ºè¯</label>
        <textarea id="system-prompt" placeholder="è¾“å…¥ç³»ç»Ÿæç¤ºè¯ï¼Œå®šä¹‰AIåŠ©æ‰‹çš„è¡Œä¸ºå’Œç‰¹æ€§"></textarea>
      </div>
      <button id="add-model-btn" class="button">æ·»åŠ æ¨¡å‹</button>

      <div class="model-list">
        <h4>å·²æ·»åŠ çš„æ¨¡å‹</h4>
        <div id="model-list-container">
          <!-- æ¨¡å‹åˆ—è¡¨ -->
        </div>
      </div>
    </div>
  </div>

  <!-- ç¡®è®¤å¯¹è¯æ¡† -->
  <div id="confirm-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">ç¡®è®¤åˆ é™¤</h3>
        <button class="close-button" id="close-confirm">&times;</button>
      </div>
      <div class="modal-body">
        <p id="confirm-message">ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¨¡å‹å—ï¼Ÿ</p>
      </div>
      <div class="modal-footer">
        <button id="confirm-cancel" class="button button-secondary">å–æ¶ˆ</button>
        <button id="confirm-ok" class="button">ç¡®å®š</button>
      </div>
    </div>
  </div>

  <script>
    // æ¨¡å‹ç®¡ç†å™¨ç±»
    class ModelManager {
        constructor() {
            this.modelConfigs = [];
            this.currentModelIndex = 0;
            this.loadModelConfigs();
        }

        // åŠ è½½æ¨¡å‹é…ç½®
        loadModelConfigs() {
            this.modelConfigs = window.preload.dbUtil.getModelConfig() || [];
            this.currentModelIndex = window.preload.dbUtil.getModelIndex() || 0;
            
            // ç¡®ä¿æ¯ä¸ªæ¨¡å‹é…ç½®éƒ½æœ‰å¿…è¦çš„å­—æ®µ
            this.modelConfigs = this.modelConfigs.map(config => ({
                name: config.name || 'æœªå‘½åæ¨¡å‹',
                model: config.model || 'gpt-3.5-turbo',
                url: config.url || 'https://api.openai.com/v1/chat/completions',
                key: config.key || '',
                systemPrompt: config.systemPrompt || ''
            }));
        }

        // éªŒè¯æ¨¡å‹é…ç½®
        validateModelConfig(config) {
            const errors = [];
            
            if (!config.name || config.name.trim() === '') {
                errors.push('æ¨¡å‹åç§°ä¸èƒ½ä¸ºç©º');
            }
            
            if (!config.model || config.model.trim() === '') {
                errors.push('æ¨¡å‹IDä¸èƒ½ä¸ºç©º');
            }
            
            if (!config.url || config.url.trim() === '') {
                errors.push('APIåœ°å€ä¸èƒ½ä¸ºç©º');
            } else if (!this.isValidUrl(config.url)) {
                errors.push('APIåœ°å€æ ¼å¼ä¸æ­£ç¡®');
            }
            
            if (!config.key || config.key.trim() === '') {
                errors.push('APIå¯†é’¥ä¸èƒ½ä¸ºç©º');
            }
            
            return {
                isValid: errors.length === 0,
                errors
            };
        }

        // éªŒè¯URLæ ¼å¼
        isValidUrl(url) {
            try {
                new URL(url);
                return true;
            } catch {
                return false;
            }
        }

        // æ·»åŠ æ¨¡å‹
        addModel(config) {
            const validation = this.validateModelConfig(config);
            if (!validation.isValid) {
                throw new Error(validation.errors.join('\n'));
            }

            this.modelConfigs.push(config);
            this.saveModelConfigs();
        }

        // æ›´æ–°æ¨¡å‹
        updateModel(index, config) {
            if (index < 0 || index >= this.modelConfigs.length) {
                throw new Error('æ¨¡å‹ç´¢å¼•æ— æ•ˆ');
            }

            const validation = this.validateModelConfig(config);
            if (!validation.isValid) {
                throw new Error(validation.errors.join('\n'));
            }

            this.modelConfigs[index] = config;
            this.saveModelConfigs();
        }

        // åˆ é™¤æ¨¡å‹
        deleteModel(index) {
            if (index < 0 || index >= this.modelConfigs.length) {
                throw new Error('æ¨¡å‹ç´¢å¼•æ— æ•ˆ');
            }

            this.modelConfigs.splice(index, 1);
            this.saveModelConfigs();
        }

        // ä¿å­˜æ¨¡å‹é…ç½®
        saveModelConfigs() {
            window.preload.dbUtil.saveModelConfig(this.modelConfigs);
        }

        // è·å–å½“å‰é€‰ä¸­çš„æ¨¡å‹
        getCurrentModel() {
            return this.modelConfigs[this.currentModelIndex];
        }

        // è®¾ç½®å½“å‰é€‰ä¸­çš„æ¨¡å‹
        setCurrentModel(index) {
            if (index < 0 || index >= this.modelConfigs.length) {
                throw new Error('æ¨¡å‹ç´¢å¼•æ— æ•ˆ');
            }
            this.currentModelIndex = index;
            window.preload.dbUtil.saveModelIndex(index);
        }

        // è·å–æ‰€æœ‰æ¨¡å‹
        getAllModels() {
            return [...this.modelConfigs];
        }
    }

    // è·å–DOMå…ƒç´ 
    const chatList = document.getElementById('chat-list');
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const newChatBtn = document.getElementById('new-chat-btn');
    const startChatBtn = document.getElementById('start-chat-btn');
    const settingsBtn = document.getElementById('settings-btn');
    const modelSelect = document.getElementById('model-select');
    const chatTitle = document.getElementById('chat-title');
    const emptyState = document.getElementById('empty-state');
    const chatContainer = document.getElementById('chat-container');
    
    // é€šçŸ¥ç›¸å…³å…ƒç´ 
    const notification = document.getElementById('notification');
    const notificationContent = notification.querySelector('.notification-content');
    const notificationClose = notification.querySelector('.notification-close');
    
    // è®¾ç½®ç›¸å…³å…ƒç´ 
    const settingsModal = document.getElementById('settings-modal');
    const closeSettings = document.getElementById('close-settings');
    const modelName = document.getElementById('model-name');
    const modelId = document.getElementById('model-id');
    const apiUrl = document.getElementById('api-url');
    const apiKey = document.getElementById('api-key');
    const systemPrompt = document.getElementById('system-prompt');
    const addModelBtn = document.getElementById('add-model-btn');
    const modelListContainer = document.getElementById('model-list-container');
    
    // æ¨¡å‹é€‰æ‹©ç›¸å…³å…ƒç´ 
    const modelSelectModal = document.getElementById('model-select-modal');
    const modelSelectList = document.getElementById('model-select-list');
    const modelSelectInput = document.getElementById('model-select-input');
    
    // ç¡®è®¤å¯¹è¯æ¡†ç›¸å…³å…ƒç´ 
    const confirmModal = document.getElementById('confirm-modal');
    const confirmMessage = document.getElementById('confirm-message');
    const confirmOk = document.getElementById('confirm-ok');
    const confirmCancel = document.getElementById('confirm-cancel');
    const closeConfirm = document.getElementById('close-confirm');
    
    // å½“å‰ä¼šè¯ID
    let currentSessionId = null;
    // å½“å‰ä¼šè¯æ¶ˆæ¯
    let currentMessages = [];
    // æ¨¡å‹ç®¡ç†å™¨å®ä¾‹
    const modelManager = new ModelManager();
    
    // æ›´æ–°æ¨¡å‹é€‰æ‹©æŒ‰é’®æ–‡æœ¬
    function updateModelButtonText() {
        const selectedModel = modelManager.getCurrentModel();
        if (selectedModel) {
            modelSelect.value = modelManager.currentModelIndex;
            modelSelect.selectedIndex = modelManager.currentModelIndex;
        }
    }
    
    // åˆå§‹åŒ–
    function init() {
        // åŠ è½½èŠå¤©è®°å½•
        loadChatSessions();
        // è®¾ç½®äº‹ä»¶ç›‘å¬
        setupEventListeners();
        // é…ç½®Markdownæ¸²æŸ“å™¨
        configureMarkdown();
        // æ›´æ–°æ¨¡å‹é€‰æ‹©
        updateModelSelect();
        updateModelList();
        
        // æ¯æ¬¡å¯åŠ¨æ—¶åˆ›å»ºæ–°å¯¹è¯
        createNewChat();
        
        // èšç„¦åˆ°è¾“å…¥æ¡†
        messageInput.focus();
    }
    
    // é…ç½®Markdownæ¸²æŸ“å™¨
    function configureMarkdown() {
      marked.setOptions({
        highlight: function(code, lang) {
          const language = hljs.getLanguage(lang) ? lang : 'plaintext';
          return hljs.highlight(code, { language }).value;
        },
        langPrefix: 'hljs language-',
        gfm: true,
        breaks: true
      });
    }
    
    // æ›´æ–°æ¨¡å‹é€‰æ‹©ä¸‹æ‹‰æ¡†
    function updateModelSelect() {
        modelSelect.innerHTML = '';
        
        const models = modelManager.getAllModels();
        if (models.length === 0) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'è¯·å…ˆæ·»åŠ æ¨¡å‹';
            modelSelect.appendChild(option);
            modelSelect.disabled = true;
        } else {
            modelSelect.disabled = false;
            models.forEach((config, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = config.name;
                modelSelect.appendChild(option);
            });
        }
    }
    
    // æ›´æ–°æ¨¡å‹åˆ—è¡¨
    function updateModelList() {
        modelListContainer.innerHTML = '';
        
        const models = modelManager.getAllModels();
        if (models.length === 0) {
            modelListContainer.innerHTML = '<p>æš‚æ— æ¨¡å‹ï¼Œè¯·æ·»åŠ </p>';
            return;
        }
        
        models.forEach((config, index) => {
            const modelItem = document.createElement('div');
            modelItem.className = 'model-item';
            
            const modelInfo = document.createElement('div');
            modelInfo.className = 'model-item-info';
            
            const modelItemName = document.createElement('div');
            modelItemName.className = 'model-item-name';
            modelItemName.textContent = config.name;
            
            const modelItemUrl = document.createElement('div');
            modelItemUrl.className = 'model-item-url';
            modelItemUrl.textContent = `${config.url} (${config.model})`;
            
            const modelItemPrompt = document.createElement('div');
            modelItemPrompt.className = 'model-item-url';
            modelItemPrompt.textContent = `ç³»ç»Ÿæç¤ºè¯: ${config.systemPrompt || 'æ— '}`;
            
            modelInfo.appendChild(modelItemName);
            modelInfo.appendChild(modelItemUrl);
            modelInfo.appendChild(modelItemPrompt);
            
            const modelActions = document.createElement('div');
            modelActions.className = 'model-item-actions';
            
            const editBtn = document.createElement('button');
            editBtn.className = 'button';
            editBtn.textContent = 'ç¼–è¾‘';
            editBtn.onclick = () => editModel(index);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'button button-secondary';
            deleteBtn.textContent = 'åˆ é™¤';
            deleteBtn.onclick = () => deleteModel(index);
            
            modelActions.appendChild(editBtn);
            modelActions.appendChild(deleteBtn);
            
            modelItem.appendChild(modelInfo);
            modelItem.appendChild(modelActions);
            
            modelListContainer.appendChild(modelItem);
        });
    }
    
    // ç¼–è¾‘æ¨¡å‹
    function editModel(index) {
        const config = modelManager.getAllModels()[index];
        if (!config) {
            showNotification('æ¨¡å‹é…ç½®ä¸å­˜åœ¨', 'error');
            return;
        }
        
        // ä¿å­˜å½“å‰ç¼–è¾‘çš„æ¨¡å‹ç´¢å¼•
        addModelBtn.dataset.editIndex = index;
        
        // å¡«å……è¡¨å•
        modelName.value = config.name || '';
        modelId.value = config.model || '';
        apiUrl.value = config.url || '';
        apiKey.value = config.key || '';
        systemPrompt.value = config.systemPrompt || '';
        
        // ä¿®æ”¹æ·»åŠ æŒ‰é’®çš„æ–‡æœ¬
        addModelBtn.textContent = 'æ›´æ–°æ¨¡å‹';
    }
    
    // æ›´æ–°æ¨¡å‹
    function updateModel(index) {
        const config = {
            name: modelName.value.trim(),
            model: modelId.value.trim(),
            url: apiUrl.value.trim(),
            key: apiKey.value.trim(),
            systemPrompt: systemPrompt.value.trim()
        };
        
        try {
            modelManager.updateModel(index, config);
            
            // æ›´æ–°UI
            updateModelSelect();
            updateModelList();
            
            // é‡ç½®è¡¨å•å’ŒæŒ‰é’®
            resetModelForm();
            
            // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
            showNotification('æ¨¡å‹å·²æ›´æ–°', 'success');
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }
    
    // é‡ç½®æ¨¡å‹è¡¨å•
    function resetModelForm() {
        // æ¸…é™¤ç¼–è¾‘ç´¢å¼•
        delete addModelBtn.dataset.editIndex;
        
        modelName.value = '';
        modelId.value = '';
        apiUrl.value = '';
        apiKey.value = '';
        systemPrompt.value = '';
        addModelBtn.textContent = 'æ·»åŠ æ¨¡å‹';
    }
    
    // åŠ è½½èŠå¤©è®°å½•
    function loadChatSessions() {
      const sessions = window.preload.dbUtil.getAllSessions();
      
      chatList.innerHTML = '';
      
      if (sessions.length === 0) {
        return;
      }
      
      sessions.forEach(session => {
        addChatItemToList(session);
      });
    }
    
    // æ·»åŠ èŠå¤©é¡¹åˆ°åˆ—è¡¨
    function addChatItemToList(session) {
      const chatItem = document.createElement('li');
      chatItem.className = 'chat-item';
      chatItem.dataset.id = session.id;
      
      if (currentSessionId === session.id) {
        chatItem.classList.add('active');
      }
      
      const lastMessage = session.messages[session.messages.length - 1];
      const title = session.messages[0]?.content.substring(0, 20) || 'æ–°å¯¹è¯';
      const preview = lastMessage ? `${lastMessage.role === 'user' ? 'ä½ : ' : 'AI: '}${lastMessage.content.substring(0, 30)}` : '';
      
      chatItem.innerHTML = `
        <div class="chat-item-content">
          <div class="chat-item-title">${title}</div>
          <div class="chat-item-preview">${preview}</div>
        </div>
        <div class="chat-item-delete" title="åˆ é™¤å¯¹è¯">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 6h18"></path>
            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
            <line x1="10" y1="11" x2="10" y2="17"></line>
            <line x1="14" y1="11" x2="14" y2="17"></line>
          </svg>
        </div>
      `;
      
      chatItem.addEventListener('click', (e) => {
        // å¦‚æœç‚¹å‡»çš„æ˜¯åˆ é™¤æŒ‰é’®ï¼Œä¸è§¦å‘åŠ è½½å¯¹è¯
        if (e.target.closest('.chat-item-delete')) {
          e.stopPropagation();
          deleteChatSession(session.id);
          return;
        }
        loadChatSession(session.id);
      });
      
      chatList.appendChild(chatItem);
    }
    
    // åŠ è½½èŠå¤©ä¼šè¯
    function loadChatSession(sessionId) {
      currentSessionId = sessionId;
      currentMessages = window.preload.dbUtil.getChatHistory(sessionId) || [];
      
      // æ›´æ–°UI
      updateChatUI();
      
      // æ›´æ–°æ´»åŠ¨çŠ¶æ€
      document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.id === sessionId) {
          item.classList.add('active');
        }
      });
      
      // èšç„¦åˆ°è¾“å…¥æ¡†
      messageInput.focus();
    }
    
    // åˆ›å»ºæ–°ä¼šè¯
    function createNewChat() {
      currentSessionId = Date.now().toString();
      currentMessages = [];
      
      // æ›´æ–°UI
      updateChatUI();
      
      // æ·»åŠ åˆ°åˆ—è¡¨
      const session = {
        id: currentSessionId,
        messages: currentMessages,
        lastTime: Date.now()
      };
      
      addChatItemToList(session);
      
      // ä¿å­˜åˆ°æ•°æ®åº“
      window.preload.dbUtil.saveChatHistory(currentSessionId, currentMessages);
      
      // èšç„¦åˆ°è¾“å…¥æ¡†
      messageInput.focus();
    }
    
    // æ›´æ–°èŠå¤©UI
    function updateChatUI() {
      if (currentSessionId === null) {
        emptyState.style.display = 'flex';
        chatContainer.style.display = 'none';
        return;
      }
      
      emptyState.style.display = 'none';
      chatContainer.style.display = 'flex';
      
      // æ›´æ–°æ ‡é¢˜
      if (currentMessages.length > 0) {
        chatTitle.textContent = currentMessages[0].content.substring(0, 20);
      } else {
        chatTitle.textContent = 'æ–°å¯¹è¯';
      }
      
      // æ›´æ–°æ¶ˆæ¯åˆ—è¡¨
      renderMessages();
    }
    
    // æ¸²æŸ“æ¶ˆæ¯
    function renderMessages() {
      chatMessages.innerHTML = '';
      
      currentMessages.forEach(msg => {
        const messageEl = document.createElement('div');
        messageEl.className = `message message-${msg.role === 'user' ? 'user' : 'ai'}`;
        
        const messageContent = document.createElement('div');
        
        // ä½¿ç”¨Markdownæ¸²æŸ“AIæ¶ˆæ¯
        if (msg.role === 'assistant') {
          messageContent.className = 'markdown-content';
          messageContent.innerHTML = marked.parse(msg.content);
          // é«˜äº®ä»£ç å—
          messageEl.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightElement(block);
          });
        } else {
          messageContent.textContent = msg.content;
        }
        
        const messageTime = document.createElement('div');
        messageTime.className = 'message-time';
        messageTime.textContent = formatTime(msg.timestamp);
        
        messageEl.appendChild(messageContent);
        messageEl.appendChild(messageTime);
        
        chatMessages.appendChild(messageEl);
      });
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
    }
    
    // å‘é€æ¶ˆæ¯
    async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;
        
        // å¦‚æœæ²¡æœ‰å½“å‰ä¼šè¯ï¼Œåˆ›å»ºä¸€ä¸ªæ–°ä¼šè¯
        if (currentSessionId === null) {
            createNewChat();
        }
        
        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        const userMessage = {
            role: 'user',
            content: message,
            timestamp: Date.now()
        };
        
        currentMessages.push(userMessage);
        
        // æ›´æ–°UI
        messageInput.value = '';
        renderMessages();
        
        // ä¿å­˜åˆ°æ•°æ®åº“
        window.preload.dbUtil.saveChatHistory(currentSessionId, currentMessages);
        
        // æ›´æ–°èŠå¤©åˆ—è¡¨
        loadChatSessions();
        
        // è·å–é€‰ä¸­çš„æ¨¡å‹
        const selectedModel = modelManager.getCurrentModel();
        if (!selectedModel) {
            showNotification('è¯·å…ˆæ·»åŠ æ¨¡å‹é…ç½®', 'warning');
            return;
        }
        
        // å‡†å¤‡å‘é€ç»™AIçš„æ¶ˆæ¯
        const aiMessages = [];
        
        // æ·»åŠ ç³»ç»Ÿæç¤ºè¯
        if (selectedModel.systemPrompt) {
            aiMessages.push({
                role: 'system',
                content: selectedModel.systemPrompt
            });
        }
        
        // æ·»åŠ å¯¹è¯å†å²
        currentMessages.forEach(msg => {
            if (msg.role !== 'system') {
                aiMessages.push({
                    role: msg.role,
                    content: msg.content
                });
            }
        });
        
        try {
            // æ·»åŠ AIå›å¤å ä½
            const aiMessage = {
                role: 'assistant',
                content: '',
                timestamp: Date.now()
            };
            
            currentMessages.push(aiMessage);
            renderMessages();
            
            // è°ƒç”¨AI APIå¹¶å¤„ç†æµå¼è¾“å‡º
            await window.preload.aiUtil.callAI(selectedModel, aiMessages, (content) => {
                aiMessage.content = content;
                renderMessages();
            });
            
            // ä¿å­˜åˆ°æ•°æ®åº“
            window.preload.dbUtil.saveChatHistory(currentSessionId, currentMessages);
            
            // æ›´æ–°èŠå¤©åˆ—è¡¨
            loadChatSessions();
        } catch (error) {
            console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
            
            // ç§»é™¤åŠ è½½ä¸­æ¶ˆæ¯
            currentMessages.pop();
            
            // æ·»åŠ é”™è¯¯æ¶ˆæ¯
            const errorMessage = {
                role: 'assistant',
                content: `å‘ç”Ÿé”™è¯¯: ${error.message}`,
                timestamp: Date.now()
            };
            
            currentMessages.push(errorMessage);
            
            // æ›´æ–°UI
            renderMessages();
            
            // ä¿å­˜åˆ°æ•°æ®åº“
            window.preload.dbUtil.saveChatHistory(currentSessionId, currentMessages);
        }
    }
    
    // æ·»åŠ æ¨¡å‹
    function addModel() {
        const config = {
            name: modelName.value.trim(),
            model: modelId.value.trim(),
            url: apiUrl.value.trim(),
            key: apiKey.value.trim(),
            systemPrompt: systemPrompt.value.trim()
        };
        
        try {
            modelManager.addModel(config);
            
            // æ›´æ–°UI
            updateModelSelect();
            updateModelList();
            
            // æ¸…ç©ºè¡¨å•
            resetModelForm();
            
            // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
            showNotification('æ¨¡å‹å·²æ·»åŠ ', 'success');
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }
    
    // åˆ é™¤æ¨¡å‹
    function deleteModel(index) {
        showConfirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¨¡å‹å—ï¼Ÿ', (confirmed) => {
            if (confirmed) {
                try {
                    modelManager.deleteModel(index);
                    
                    // æ›´æ–°UI
                    updateModelSelect();
                    updateModelList();
                    
                    // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                    showNotification('æ¨¡å‹å·²åˆ é™¤', 'success');
                } catch (error) {
                    showNotification(error.message, 'error');
                }
            }
        });
    }
    
    // åˆ é™¤èŠå¤©ä¼šè¯
    function deleteChatSession(sessionId) {
      // ä»æ•°æ®åº“ä¸­åˆ é™¤
      window.preload.dbUtil.deleteChatHistory(sessionId);
      
      // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ä¼šè¯ï¼Œæ¸…ç©ºå½“å‰ä¼šè¯
      if (currentSessionId === sessionId) {
        currentSessionId = null;
        currentMessages = [];
        updateChatUI();
      }
      
      // é‡æ–°åŠ è½½èŠå¤©åˆ—è¡¨
      loadChatSessions();
      
      // æ˜¾ç¤ºåˆ é™¤æˆåŠŸé€šçŸ¥
      showNotification('å¯¹è¯å·²åˆ é™¤', 'success');
    }
    
    // æ˜¾ç¤ºé€šçŸ¥
    function showNotification(message, type = 'info', duration = 3000) {
      // è®¾ç½®é€šçŸ¥å†…å®¹å’Œç±»å‹
      notificationContent.textContent = message;
      notification.className = `notification ${type}`;
      
      // æ˜¾ç¤ºé€šçŸ¥
      notification.classList.add('show');
      
      // è®¾ç½®è‡ªåŠ¨å…³é—­
      setTimeout(() => {
        hideNotification();
      }, duration);
    }
    
    // éšè—é€šçŸ¥
    function hideNotification() {
      notification.classList.remove('show');
    }
    
    // è®¾ç½®é€šçŸ¥å…³é—­æŒ‰é’®äº‹ä»¶
    notificationClose.addEventListener('click', hideNotification);
    
    // æ˜¾ç¤ºæ¨¡å‹é€‰æ‹©å¼¹çª—
    function showModelSelectModal() {
      if (modelManager.getAllModels().length === 0) {
        showNotification('è¯·å…ˆæ·»åŠ æ¨¡å‹é…ç½®', 'warning');
        return;
      }
      
      // ç”Ÿæˆæ¨¡å‹åˆ—è¡¨
      modelSelectList.innerHTML = '';
      let activeIndex = parseInt(modelSelect.value) || 0;
      
      // æ˜¾ç¤ºæ‰€æœ‰æ¨¡å‹
      updateModelListItems(modelManager.getAllModels(), activeIndex);
      
      // æ˜¾ç¤ºå¼¹çª—
      modelSelectModal.classList.add('show');
      
      // èšç„¦åˆ°æœç´¢æ¡†
      modelSelectInput.focus();
      
      // ç›‘å¬é”®ç›˜äº‹ä»¶
      document.addEventListener('keydown', handleModelSelectKeydown);
    }
    
    // æ›´æ–°æ¨¡å‹åˆ—è¡¨é¡¹
    function updateModelListItems(models, activeIndex = 0) {
      modelSelectList.innerHTML = '';
      
      models.forEach((model, index) => {
        const item = document.createElement('li');
        item.className = 'model-select-item';
        if (index === activeIndex) {
          item.classList.add('active');
        }
        
        item.innerHTML = `
          <div class="model-select-name">${model.name}</div>
          <div class="model-select-shortcut">${index + 1}</div>
        `;
        
        item.addEventListener('click', () => {
          selectModel(index);
        });
        
        modelSelectList.appendChild(item);
      });
    }
    
    // å¤„ç†æ¨¡å‹é€‰æ‹©é”®ç›˜äº‹ä»¶
    function handleModelSelectKeydown(e) {
      const items = modelSelectList.querySelectorAll('.model-select-item');
      const activeItem = modelSelectList.querySelector('.model-select-item.active');
      let activeIndex = Array.from(items).indexOf(activeItem);
      
      // å¦‚æœæ­£åœ¨è¾“å…¥æœç´¢å†…å®¹ï¼Œä¸å¤„ç†å…¶ä»–æŒ‰é”®
      if (e.target === modelSelectInput) {
        if (e.key === 'Enter') {
          e.preventDefault();
          if (activeItem) {
            const index = Array.from(items).indexOf(activeItem);
            selectModel(index);
          }
        }
        return;
      }
      
      switch (e.key) {
        case 'Escape':
          hideModelSelectModal();
          break;
          
        case 'ArrowUp':
          e.preventDefault();
          if (activeIndex > 0) {
            activeItem.classList.remove('active');
            items[activeIndex - 1].classList.add('active');
            items[activeIndex - 1].scrollIntoView({ block: 'nearest' });
          }
          break;
          
        case 'ArrowDown':
          e.preventDefault();
          if (activeIndex < items.length - 1) {
            activeItem.classList.remove('active');
            items[activeIndex + 1].classList.add('active');
            items[activeIndex + 1].scrollIntoView({ block: 'nearest' });
          }
          break;
          
        case 'Enter':
          e.preventDefault();
          if (activeItem) {
            const index = Array.from(items).indexOf(activeItem);
            selectModel(index);
          }
          break;
          
        default:
          // æ•°å­—é”®é€‰æ‹©ï¼ˆå¯é€‰ï¼‰
          const number = parseInt(e.key);
          if (!isNaN(number) && number >= 1 && number <= modelManager.getAllModels().length) {
            selectModel(number - 1);
          }
      }
    }
    
    // æœç´¢æ¨¡å‹
    function searchModels(query) {
      const filteredModels = modelManager.getAllModels().filter(model => 
        model.name.toLowerCase().includes(query.toLowerCase())
      );
      
      updateModelListItems(filteredModels);
      
      // å¦‚æœæœ‰åŒ¹é…é¡¹ï¼Œé€‰ä¸­ç¬¬ä¸€ä¸ª
      if (filteredModels.length > 0) {
        const firstItem = modelSelectList.querySelector('.model-select-item');
        if (firstItem) {
          firstItem.classList.add('active');
        }
      }
    }
    
    // é€‰æ‹©æ¨¡å‹
    function selectModel(index) {
      try {
        // è·å–å½“å‰æ˜¾ç¤ºçš„æ¨¡å‹åˆ—è¡¨
        const displayedItems = modelSelectList.querySelectorAll('.model-select-item');
        const activeItem = modelSelectList.querySelector('.model-select-item.active');
        const activeIndex = Array.from(displayedItems).indexOf(activeItem);
        
        // è·å–åŸå§‹æ¨¡å‹åˆ—è¡¨
        const allModels = modelManager.getAllModels();
        
        // å¦‚æœæ­£åœ¨æœç´¢ï¼Œéœ€è¦æ‰¾åˆ°å¯¹åº”çš„åŸå§‹ç´¢å¼•
        let originalIndex = index;
        if (modelSelectInput.value.trim() !== '') {
          const searchQuery = modelSelectInput.value.toLowerCase();
          const matchingModels = allModels.filter(model => 
            model.name.toLowerCase().includes(searchQuery)
          );
          if (matchingModels.length > 0) {
            // ä½¿ç”¨å½“å‰é€‰ä¸­çš„æ¨¡å‹åç§°æ¥æ‰¾åˆ°åŸå§‹ç´¢å¼•
            const selectedModelName = matchingModels[activeIndex].name;
            originalIndex = allModels.findIndex(model => model.name === selectedModelName);
          }
        }
        
        modelManager.setCurrentModel(originalIndex);
        
        // æ›´æ–°ä¸‹æ‹‰æ¡†çš„å€¼å’Œæ˜¾ç¤ºæ–‡æœ¬
        modelSelect.value = originalIndex;
        modelSelect.selectedIndex = originalIndex;
        
        // éšè—å¼¹çª—
        hideModelSelectModal();
        
        // æ˜¾ç¤ºé€šçŸ¥
        showNotification(`å·²åˆ‡æ¢åˆ°æ¨¡å‹: ${modelManager.getCurrentModel().name}`, 'success');
        
        // æ¸…ç©ºæœç´¢æ¡†
        modelSelectInput.value = '';
      } catch (error) {
        showNotification(error.message, 'error');
      }
    }
    
    // éšè—æ¨¡å‹é€‰æ‹©å¼¹çª—
    function hideModelSelectModal() {
      modelSelectModal.classList.remove('show');
      document.removeEventListener('keydown', handleModelSelectKeydown);
      // èšç„¦å›è¾“å…¥æ¡†
      messageInput.focus();
    }
    
    // è®¾ç½®äº‹ä»¶ç›‘å¬
    function setupEventListeners() {
      // å‘é€æ¶ˆæ¯
      sendButton.addEventListener('click', sendMessage);
      
      // æŒ‰Enterå‘é€æ¶ˆæ¯
      messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      
      // è¾“å…¥æ¡†å†…å®¹å˜åŒ–
      messageInput.addEventListener('input', () => {
        sendButton.disabled = messageInput.value.trim() === '';
      });
      
      // æ–°å»ºèŠå¤©
      newChatBtn.addEventListener('click', createNewChat);
      startChatBtn.addEventListener('click', createNewChat);
      
      // è®¾ç½®æŒ‰é’®
      settingsBtn.addEventListener('click', () => {
        settingsModal.classList.add('active');
      });
      
      // å…³é—­è®¾ç½®
      closeSettings.addEventListener('click', () => {
        settingsModal.classList.remove('active');
        // é‡æ–°èšç„¦åˆ°è¾“å…¥æ¡†
        messageInput.focus();
      });
      
      // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
      settingsModal.addEventListener('click', (e) => {
        if (e.target === settingsModal) {
          settingsModal.classList.remove('active');
          // é‡æ–°èšç„¦åˆ°è¾“å…¥æ¡†
          messageInput.focus();
        }
      });
      
      // æ·»åŠ æ¨¡å‹æŒ‰é’®äº‹ä»¶ç›‘å¬
      addModelBtn.addEventListener('click', () => {
        if (addModelBtn.textContent === 'æ›´æ–°æ¨¡å‹') {
          // è·å–ç¼–è¾‘ç´¢å¼•
          const editIndex = parseInt(addModelBtn.dataset.editIndex);
          if (!isNaN(editIndex)) {
            updateModel(editIndex);
          }
        } else {
          addModel();
        }
      });
      
      // ç›‘å¬å¿«æ·é”®
      document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.altKey && e.key.toLowerCase() === 't') {
          e.preventDefault();
          showModelSelectModal();
        }
      });
      
      // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
      modelSelectModal.addEventListener('click', (e) => {
        if (e.target === modelSelectModal) {
          hideModelSelectModal();
          // é‡æ–°èšç„¦åˆ°è¾“å…¥æ¡†
          messageInput.focus();
        }
      });
      
      // æœç´¢æ¡†è¾“å…¥äº‹ä»¶
      modelSelectInput.addEventListener('input', (e) => {
        searchModels(e.target.value);
      });
      
      // æœç´¢æ¡†é”®ç›˜äº‹ä»¶
      modelSelectInput.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          const firstItem = modelSelectList.querySelector('.model-select-item');
          if (firstItem) {
            firstItem.classList.add('active');
            firstItem.scrollIntoView({ block: 'nearest' });
          }
        }
      });
    }
    
    // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
    function showConfirm(message, callback) {
      confirmMessage.textContent = message;
      confirmModal.classList.add('active');
      
      // è®¾ç½®ç¡®è®¤æŒ‰é’®çš„å›è°ƒ
      const handleConfirm = () => {
        confirmModal.classList.remove('active');
        callback(true);
        // ç§»é™¤äº‹ä»¶ç›‘å¬
        confirmOk.removeEventListener('click', handleConfirm);
        confirmCancel.removeEventListener('click', handleCancel);
        closeConfirm.removeEventListener('click', handleCancel);
      };
      
      // è®¾ç½®å–æ¶ˆæŒ‰é’®çš„å›è°ƒ
      const handleCancel = () => {
        confirmModal.classList.remove('active');
        callback(false);
        // ç§»é™¤äº‹ä»¶ç›‘å¬
        confirmOk.removeEventListener('click', handleConfirm);
        confirmCancel.removeEventListener('click', handleCancel);
        closeConfirm.removeEventListener('click', handleCancel);
      };
      
      // æ·»åŠ äº‹ä»¶ç›‘å¬
      confirmOk.addEventListener('click', handleConfirm);
      confirmCancel.addEventListener('click', handleCancel);
      closeConfirm.addEventListener('click', handleCancel);
    }
    
    // åˆå§‹åŒ–åº”ç”¨
    document.addEventListener('DOMContentLoaded', () => {
      // è·å–ä¿å­˜çš„æ¨¡å‹é…ç½®
      const savedModelConfigs = window.preload.dbUtil.getModelConfig()
      if (savedModelConfigs && savedModelConfigs.length > 0) {
        modelManager.modelConfigs = savedModelConfigs
      }
      
      // è·å–ä¿å­˜çš„æ¨¡å‹ç´¢å¼•
      const savedModelIndex = window.preload.dbUtil.getModelIndex()
      if (savedModelIndex !== undefined) {
        currentSessionId = savedModelIndex
        updateModelButtonText()
      }
      
      // åˆå§‹åŒ–å…¶ä»–UIå…ƒç´ 
      init()
    });
  </script>
</body>
</html>
