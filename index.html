<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI聊天助手</title>
  <!-- 引入Markdown渲染库 -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/highlight.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: #f8f9fa;
      color: #333;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    .sidebar {
      width: 250px;
      background-color: #2d2d2d;
      color: #f8f9fa;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #444;
    }
    .sidebar-header {
      padding: 15px;
      border-bottom: 1px solid #444;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .sidebar-content {
      flex: 1;
      overflow-y: auto;
    }
    .chat-list {
      list-style: none;
    }
    .chat-item {
      padding: 12px 15px;
      cursor: pointer;
      border-bottom: 1px solid #444;
      transition: background-color 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-item:hover {
      background-color: #3d3d3d;
    }
    .chat-item.active {
      background-color: #4d4d4d;
      border-left: 3px solid #e0e0e0;
    }
    .chat-item-content {
      flex: 1;
      overflow: hidden;
    }
    .chat-item-title {
      font-weight: 500;
      margin-bottom: 5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .chat-item-preview {
      font-size: 12px;
      color: #aaa;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .chat-item-delete {
      width: 20px;
      height: 20px;
      opacity: 0;
      transition: opacity 0.2s;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
    }
    .chat-item:hover .chat-item-delete {
      opacity: 1;
    }
    .chat-item-delete:hover {
      color: #ff4444;
    }
    .sidebar-footer {
      padding: 15px;
      border-top: 1px solid #444;
    }
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: #fff;
    }
    .chat-header {
      padding: 15px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #f8f9fa;
    }
    .model-selector {
      display: flex;
      align-items: center;
    }
    .model-selector select {
      margin-left: 10px;
      padding: 5px;
      border-radius: 4px;
      border: 1px solid #ddd;
      background-color: #fff;
    }
    .chat-messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      background-color: #f8f9fa;
    }
    .message {
      max-width: 80%;
      margin-bottom: 15px;
      padding: 10px 15px;
      border-radius: 18px;
      position: relative;
      line-height: 1.5;
    }
    .message-user {
      align-self: flex-end;
      background-color: #e0e0e0;
      color: #333;
      border-bottom-right-radius: 5px;
    }
    .message-ai {
      align-self: flex-start;
      background-color: #f1f1f1;
      color: #333;
      border-bottom-left-radius: 5px;
    }
    .message-time {
      font-size: 10px;
      color: #999;
      margin-top: 5px;
      text-align: right;
    }
    .chat-input {
      padding: 15px;
      border-top: 1px solid #eee;
      background-color: #f8f9fa;
    }
    .input-container {
      display: flex;
      position: relative;
    }
    .message-input {
      flex: 1;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 24px;
      outline: none;
      resize: none;
      max-height: 120px;
      overflow-y: auto;
      background-color: #fff;
    }
    .send-button {
      margin-left: 10px;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background-color: #666;
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
    }
    .send-button:hover {
      background-color: #888;
    }
    .send-button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .button {
      padding: 8px 12px;
      background-color: #666;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .button:hover {
      background-color: #888;
    }
    .button-secondary {
      background-color: #555;
    }
    .button-secondary:hover {
      background-color: #777;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      width: 500px;
      max-width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .modal-title {
      font-size: 18px;
      font-weight: 500;
    }
    .close-button {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #999;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #fff;
    }
    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }
    .model-list {
      margin-top: 20px;
      border-top: 1px solid #ddd;
      padding-top: 15px;
    }
    .model-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    .model-item-info {
      flex: 1;
    }
    .model-item-name {
      font-weight: 500;
    }
    .model-item-url {
      font-size: 12px;
      color: #999;
    }
    .model-item-actions {
      display: flex;
      gap: 5px;
    }
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #999;
      text-align: center;
      padding: 20px;
      background-color: #f8f9fa;
    }
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    .empty-state-text {
      margin-bottom: 20px;
    }
    /* Markdown样式 */
    .markdown-content {
      line-height: 1.6;
    }
    .markdown-content h1, .markdown-content h2, .markdown-content h3, 
    .markdown-content h4, .markdown-content h5, .markdown-content h6 {
      margin-top: 1em;
      margin-bottom: 0.5em;
    }
    .markdown-content p {
      margin-bottom: 1em;
    }
    .markdown-content ul, .markdown-content ol {
      margin-bottom: 1em;
      padding-left: 2em;
    }
    .markdown-content pre {
      background-color: #f0f0f0;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      margin-bottom: 1em;
    }
    .markdown-content code {
      background-color: #f0f0f0;
      padding: 2px 4px;
      border-radius: 3px;
      font-family: monospace;
    }
    .markdown-content pre code {
      padding: 0;
      background-color: transparent;
    }
    .markdown-content blockquote {
      border-left: 4px solid #ddd;
      padding-left: 1em;
      margin-left: 0;
      margin-bottom: 1em;
      color: #666;
    }
    .markdown-content table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 1em;
    }
    .markdown-content table th, .markdown-content table td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    .markdown-content table th {
      background-color: #f0f0f0;
      text-align: left;
    }
    .markdown-content img {
      max-width: 100%;
      height: auto;
    }
    /* 暗色主题代码高亮 */
    .hljs {
      background: #282c34;
      color: #abb2bf;
      border-radius: 4px;
    }
    /* 通知组件样式 */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      background-color: #2d2d2d;
      color: #fff;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      gap: 10px;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.3s ease;
      z-index: 1000;
    }
    .notification.show {
      opacity: 1;
      transform: translateX(0);
    }
    .notification.success {
      background-color: #4caf50;
    }
    .notification.error {
      background-color: #f44336;
    }
    .notification.warning {
      background-color: #ff9800;
    }
    .notification-icon {
      font-size: 20px;
    }
    .notification-content {
      flex: 1;
    }
    .notification-close {
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      padding: 0;
      font-size: 16px;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    .notification-close:hover {
      opacity: 1;
    }
    /* 模型选择弹窗样式 */
    .model-select-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #2d2d2d;
      color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      padding: 20px;
      min-width: 400px;
      max-width: 600px;
      z-index: 1001;
      display: none;
    }
    .model-select-modal.show {
      display: block;
    }
    .model-select-title {
      font-size: 14px;
      color: #999;
      margin-bottom: 10px;
      padding: 0 10px;
    }
    .model-select-search {
      margin-bottom: 10px;
    }
    .model-select-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .model-select-list {
      list-style: none;
      margin: 0;
      padding: 0;
      max-height: 300px;
      overflow-y: auto;
    }
    .model-select-item {
      padding: 8px 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background-color 0.2s;
      border-radius: 4px;
      margin: 2px 0;
    }
    .model-select-item:hover {
      background-color: #3d3d3d;
    }
    .model-select-item.active {
      background-color: #4d4d4d;
    }
    .model-select-name {
      flex: 1;
      font-size: 14px;
    }
    .model-select-shortcut {
      color: #999;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .model-select-item:hover .model-select-shortcut {
      opacity: 1;
    }
    /* 滚动条样式 */
    .model-select-list::-webkit-scrollbar {
      width: 8px;
    }
    .model-select-list::-webkit-scrollbar-track {
      background: #2d2d2d;
    }
    .model-select-list::-webkit-scrollbar-thumb {
      background: #4d4d4d;
      border-radius: 4px;
    }
    .model-select-list::-webkit-scrollbar-thumb:hover {
      background: #5d5d5d;
    }
    /* 确认对话框样式 */
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    .modal-body {
      padding: 15px 0;
    }
  </style>
</head>
<body>
  <!-- 通知组件 -->
  <div id="notification" class="notification">
    <span class="notification-icon">ℹ️</span>
    <span class="notification-content"></span>
    <button class="notification-close">&times;</button>
  </div>

  <!-- 模型选择弹窗 -->
  <div id="model-select-modal" class="model-select-modal">
    <div class="model-select-title">选择模型 (Ctrl+Alt+T)</div>
    <div class="model-select-search">
      <input type="text" id="model-select-input" class="model-select-input" placeholder="输入模型名称搜索...">
    </div>
    <ul id="model-select-list" class="model-select-list">
      <!-- 模型列表将通过JavaScript动态生成 -->
    </ul>
  </div>
  <div class="container">
    <!-- 侧边栏 -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h2>聊天记录</h2>
        <button id="new-chat-btn" class="button">新对话</button>
      </div>
      <div class="sidebar-content">
        <ul id="chat-list" class="chat-list">
          <!-- 聊天记录列表 -->
        </ul>
      </div>
      <div class="sidebar-footer">
        <button id="settings-btn" class="button button-secondary">模型设置</button>
      </div>
    </div>

    <!-- 主内容区 -->
    <div class="main-content">
      <div id="empty-state" class="empty-state">
        <div class="empty-state-icon">💬</div>
        <div class="empty-state-text">开始一个新的对话，或从左侧选择历史记录</div>
        <button id="start-chat-btn" class="button">开始新对话</button>
      </div>

      <div id="chat-container" style="display: none; flex-direction: column; height: 100%;">
        <div class="chat-header">
          <h2 id="chat-title">新对话</h2>
          <div class="model-selector">
            <span>模型:</span>
            <select id="model-select">
              <!-- 模型选项 -->
            </select>
          </div>
        </div>
        <div id="chat-messages" class="chat-messages">
          <!-- 消息内容 -->
        </div>
        <div class="chat-input">
          <div class="input-container">
            <textarea id="message-input" class="message-input" placeholder="输入消息..." rows="1"></textarea>
            <button id="send-button" class="send-button" disabled>➤</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 模型设置弹窗 -->
  <div id="settings-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">模型设置</h3>
        <button class="close-button" id="close-settings">&times;</button>
      </div>
      <div class="form-group">
        <label for="model-name">模型名称</label>
        <input type="text" id="model-name" placeholder="例如: GPT-3.5">
      </div>
      <div class="form-group">
        <label for="model-id">模型ID</label>
        <input type="text" id="model-id" placeholder="例如: gpt-3.5-turbo">
      </div>
      <div class="form-group">
        <label for="api-url">API地址</label>
        <input type="text" id="api-url" placeholder="例如: https://api.openai.com/v1/chat/completions">
      </div>
      <div class="form-group">
        <label for="api-key">API密钥</label>
        <input type="password" id="api-key" placeholder="输入您的API密钥">
      </div>
      <div class="form-group">
        <label for="system-prompt">系统提示词</label>
        <textarea id="system-prompt" placeholder="输入系统提示词，定义AI助手的行为和特性"></textarea>
      </div>
      <button id="add-model-btn" class="button">添加模型</button>

      <div class="model-list">
        <h4>已添加的模型</h4>
        <div id="model-list-container">
          <!-- 模型列表 -->
        </div>
      </div>
    </div>
  </div>

  <!-- 确认对话框 -->
  <div id="confirm-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">确认删除</h3>
        <button class="close-button" id="close-confirm">&times;</button>
      </div>
      <div class="modal-body">
        <p id="confirm-message">确定要删除这个模型吗？</p>
      </div>
      <div class="modal-footer">
        <button id="confirm-cancel" class="button button-secondary">取消</button>
        <button id="confirm-ok" class="button">确定</button>
      </div>
    </div>
  </div>

  <script>
    // 模型管理器类
    class ModelManager {
        constructor() {
            this.modelConfigs = [];
            this.currentModelIndex = 0;
            this.loadModelConfigs();
        }

        // 加载模型配置
        loadModelConfigs() {
            this.modelConfigs = window.preload.dbUtil.getModelConfig() || [];
            this.currentModelIndex = window.preload.dbUtil.getModelIndex() || 0;
            
            // 确保每个模型配置都有必要的字段
            this.modelConfigs = this.modelConfigs.map(config => ({
                name: config.name || '未命名模型',
                model: config.model || 'gpt-3.5-turbo',
                url: config.url || 'https://api.openai.com/v1/chat/completions',
                key: config.key || '',
                systemPrompt: config.systemPrompt || ''
            }));
        }

        // 验证模型配置
        validateModelConfig(config) {
            const errors = [];
            
            if (!config.name || config.name.trim() === '') {
                errors.push('模型名称不能为空');
            }
            
            if (!config.model || config.model.trim() === '') {
                errors.push('模型ID不能为空');
            }
            
            if (!config.url || config.url.trim() === '') {
                errors.push('API地址不能为空');
            } else if (!this.isValidUrl(config.url)) {
                errors.push('API地址格式不正确');
            }
            
            if (!config.key || config.key.trim() === '') {
                errors.push('API密钥不能为空');
            }
            
            return {
                isValid: errors.length === 0,
                errors
            };
        }

        // 验证URL格式
        isValidUrl(url) {
            try {
                new URL(url);
                return true;
            } catch {
                return false;
            }
        }

        // 添加模型
        addModel(config) {
            const validation = this.validateModelConfig(config);
            if (!validation.isValid) {
                throw new Error(validation.errors.join('\n'));
            }

            this.modelConfigs.push(config);
            this.saveModelConfigs();
        }

        // 更新模型
        updateModel(index, config) {
            if (index < 0 || index >= this.modelConfigs.length) {
                throw new Error('模型索引无效');
            }

            const validation = this.validateModelConfig(config);
            if (!validation.isValid) {
                throw new Error(validation.errors.join('\n'));
            }

            this.modelConfigs[index] = config;
            this.saveModelConfigs();
        }

        // 删除模型
        deleteModel(index) {
            if (index < 0 || index >= this.modelConfigs.length) {
                throw new Error('模型索引无效');
            }

            this.modelConfigs.splice(index, 1);
            this.saveModelConfigs();
        }

        // 保存模型配置
        saveModelConfigs() {
            window.preload.dbUtil.saveModelConfig(this.modelConfigs);
        }

        // 获取当前选中的模型
        getCurrentModel() {
            return this.modelConfigs[this.currentModelIndex];
        }

        // 设置当前选中的模型
        setCurrentModel(index) {
            if (index < 0 || index >= this.modelConfigs.length) {
                throw new Error('模型索引无效');
            }
            this.currentModelIndex = index;
            window.preload.dbUtil.saveModelIndex(index);
        }

        // 获取所有模型
        getAllModels() {
            return [...this.modelConfigs];
        }
    }

    // 获取DOM元素
    const chatList = document.getElementById('chat-list');
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const newChatBtn = document.getElementById('new-chat-btn');
    const startChatBtn = document.getElementById('start-chat-btn');
    const settingsBtn = document.getElementById('settings-btn');
    const modelSelect = document.getElementById('model-select');
    const chatTitle = document.getElementById('chat-title');
    const emptyState = document.getElementById('empty-state');
    const chatContainer = document.getElementById('chat-container');
    
    // 通知相关元素
    const notification = document.getElementById('notification');
    const notificationContent = notification.querySelector('.notification-content');
    const notificationClose = notification.querySelector('.notification-close');
    
    // 设置相关元素
    const settingsModal = document.getElementById('settings-modal');
    const closeSettings = document.getElementById('close-settings');
    const modelName = document.getElementById('model-name');
    const modelId = document.getElementById('model-id');
    const apiUrl = document.getElementById('api-url');
    const apiKey = document.getElementById('api-key');
    const systemPrompt = document.getElementById('system-prompt');
    const addModelBtn = document.getElementById('add-model-btn');
    const modelListContainer = document.getElementById('model-list-container');
    
    // 模型选择相关元素
    const modelSelectModal = document.getElementById('model-select-modal');
    const modelSelectList = document.getElementById('model-select-list');
    const modelSelectInput = document.getElementById('model-select-input');
    
    // 确认对话框相关元素
    const confirmModal = document.getElementById('confirm-modal');
    const confirmMessage = document.getElementById('confirm-message');
    const confirmOk = document.getElementById('confirm-ok');
    const confirmCancel = document.getElementById('confirm-cancel');
    const closeConfirm = document.getElementById('close-confirm');
    
    // 当前会话ID
    let currentSessionId = null;
    // 当前会话消息
    let currentMessages = [];
    // 模型管理器实例
    const modelManager = new ModelManager();
    
    // 更新模型选择按钮文本
    function updateModelButtonText() {
        const selectedModel = modelManager.getCurrentModel();
        if (selectedModel) {
            modelSelect.value = modelManager.currentModelIndex;
            modelSelect.selectedIndex = modelManager.currentModelIndex;
        }
    }
    
    // 初始化
    function init() {
        // 加载聊天记录
        loadChatSessions();
        // 设置事件监听
        setupEventListeners();
        // 配置Markdown渲染器
        configureMarkdown();
        // 更新模型选择
        updateModelSelect();
        updateModelList();
        
        // 每次启动时创建新对话
        createNewChat();
        
        // 聚焦到输入框
        messageInput.focus();
    }
    
    // 配置Markdown渲染器
    function configureMarkdown() {
      marked.setOptions({
        highlight: function(code, lang) {
          const language = hljs.getLanguage(lang) ? lang : 'plaintext';
          return hljs.highlight(code, { language }).value;
        },
        langPrefix: 'hljs language-',
        gfm: true,
        breaks: true
      });
    }
    
    // 更新模型选择下拉框
    function updateModelSelect() {
        modelSelect.innerHTML = '';
        
        const models = modelManager.getAllModels();
        if (models.length === 0) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = '请先添加模型';
            modelSelect.appendChild(option);
            modelSelect.disabled = true;
        } else {
            modelSelect.disabled = false;
            models.forEach((config, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = config.name;
                modelSelect.appendChild(option);
            });
        }
    }
    
    // 更新模型列表
    function updateModelList() {
        modelListContainer.innerHTML = '';
        
        const models = modelManager.getAllModels();
        if (models.length === 0) {
            modelListContainer.innerHTML = '<p>暂无模型，请添加</p>';
            return;
        }
        
        models.forEach((config, index) => {
            const modelItem = document.createElement('div');
            modelItem.className = 'model-item';
            
            const modelInfo = document.createElement('div');
            modelInfo.className = 'model-item-info';
            
            const modelItemName = document.createElement('div');
            modelItemName.className = 'model-item-name';
            modelItemName.textContent = config.name;
            
            const modelItemUrl = document.createElement('div');
            modelItemUrl.className = 'model-item-url';
            modelItemUrl.textContent = `${config.url} (${config.model})`;
            
            const modelItemPrompt = document.createElement('div');
            modelItemPrompt.className = 'model-item-url';
            modelItemPrompt.textContent = `系统提示词: ${config.systemPrompt || '无'}`;
            
            modelInfo.appendChild(modelItemName);
            modelInfo.appendChild(modelItemUrl);
            modelInfo.appendChild(modelItemPrompt);
            
            const modelActions = document.createElement('div');
            modelActions.className = 'model-item-actions';
            
            const editBtn = document.createElement('button');
            editBtn.className = 'button';
            editBtn.textContent = '编辑';
            editBtn.onclick = () => editModel(index);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'button button-secondary';
            deleteBtn.textContent = '删除';
            deleteBtn.onclick = () => deleteModel(index);
            
            modelActions.appendChild(editBtn);
            modelActions.appendChild(deleteBtn);
            
            modelItem.appendChild(modelInfo);
            modelItem.appendChild(modelActions);
            
            modelListContainer.appendChild(modelItem);
        });
    }
    
    // 编辑模型
    function editModel(index) {
        const config = modelManager.getAllModels()[index];
        if (!config) {
            showNotification('模型配置不存在', 'error');
            return;
        }
        
        // 保存当前编辑的模型索引
        addModelBtn.dataset.editIndex = index;
        
        // 填充表单
        modelName.value = config.name || '';
        modelId.value = config.model || '';
        apiUrl.value = config.url || '';
        apiKey.value = config.key || '';
        systemPrompt.value = config.systemPrompt || '';
        
        // 修改添加按钮的文本
        addModelBtn.textContent = '更新模型';
    }
    
    // 更新模型
    function updateModel(index) {
        const config = {
            name: modelName.value.trim(),
            model: modelId.value.trim(),
            url: apiUrl.value.trim(),
            key: apiKey.value.trim(),
            systemPrompt: systemPrompt.value.trim()
        };
        
        try {
            modelManager.updateModel(index, config);
            
            // 更新UI
            updateModelSelect();
            updateModelList();
            
            // 重置表单和按钮
            resetModelForm();
            
            // 显示成功通知
            showNotification('模型已更新', 'success');
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }
    
    // 重置模型表单
    function resetModelForm() {
        // 清除编辑索引
        delete addModelBtn.dataset.editIndex;
        
        modelName.value = '';
        modelId.value = '';
        apiUrl.value = '';
        apiKey.value = '';
        systemPrompt.value = '';
        addModelBtn.textContent = '添加模型';
    }
    
    // 加载聊天记录
    function loadChatSessions() {
      const sessions = window.preload.dbUtil.getAllSessions();
      
      chatList.innerHTML = '';
      
      if (sessions.length === 0) {
        return;
      }
      
      sessions.forEach(session => {
        addChatItemToList(session);
      });
    }
    
    // 添加聊天项到列表
    function addChatItemToList(session) {
      const chatItem = document.createElement('li');
      chatItem.className = 'chat-item';
      chatItem.dataset.id = session.id;
      
      if (currentSessionId === session.id) {
        chatItem.classList.add('active');
      }
      
      const lastMessage = session.messages[session.messages.length - 1];
      const title = session.messages[0]?.content.substring(0, 20) || '新对话';
      const preview = lastMessage ? `${lastMessage.role === 'user' ? '你: ' : 'AI: '}${lastMessage.content.substring(0, 30)}` : '';
      
      chatItem.innerHTML = `
        <div class="chat-item-content">
          <div class="chat-item-title">${title}</div>
          <div class="chat-item-preview">${preview}</div>
        </div>
        <div class="chat-item-delete" title="删除对话">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 6h18"></path>
            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
            <line x1="10" y1="11" x2="10" y2="17"></line>
            <line x1="14" y1="11" x2="14" y2="17"></line>
          </svg>
        </div>
      `;
      
      chatItem.addEventListener('click', (e) => {
        // 如果点击的是删除按钮，不触发加载对话
        if (e.target.closest('.chat-item-delete')) {
          e.stopPropagation();
          deleteChatSession(session.id);
          return;
        }
        loadChatSession(session.id);
      });
      
      chatList.appendChild(chatItem);
    }
    
    // 加载聊天会话
    function loadChatSession(sessionId) {
      currentSessionId = sessionId;
      currentMessages = window.preload.dbUtil.getChatHistory(sessionId) || [];
      
      // 更新UI
      updateChatUI();
      
      // 更新活动状态
      document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.id === sessionId) {
          item.classList.add('active');
        }
      });
      
      // 聚焦到输入框
      messageInput.focus();
    }
    
    // 创建新会话
    function createNewChat() {
      currentSessionId = Date.now().toString();
      currentMessages = [];
      
      // 更新UI
      updateChatUI();
      
      // 添加到列表
      const session = {
        id: currentSessionId,
        messages: currentMessages,
        lastTime: Date.now()
      };
      
      addChatItemToList(session);
      
      // 保存到数据库
      window.preload.dbUtil.saveChatHistory(currentSessionId, currentMessages);
      
      // 聚焦到输入框
      messageInput.focus();
    }
    
    // 更新聊天UI
    function updateChatUI() {
      if (currentSessionId === null) {
        emptyState.style.display = 'flex';
        chatContainer.style.display = 'none';
        return;
      }
      
      emptyState.style.display = 'none';
      chatContainer.style.display = 'flex';
      
      // 更新标题
      if (currentMessages.length > 0) {
        chatTitle.textContent = currentMessages[0].content.substring(0, 20);
      } else {
        chatTitle.textContent = '新对话';
      }
      
      // 更新消息列表
      renderMessages();
    }
    
    // 渲染消息
    function renderMessages() {
      chatMessages.innerHTML = '';
      
      currentMessages.forEach(msg => {
        const messageEl = document.createElement('div');
        messageEl.className = `message message-${msg.role === 'user' ? 'user' : 'ai'}`;
        
        const messageContent = document.createElement('div');
        
        // 使用Markdown渲染AI消息
        if (msg.role === 'assistant') {
          messageContent.className = 'markdown-content';
          messageContent.innerHTML = marked.parse(msg.content);
          // 高亮代码块
          messageEl.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightElement(block);
          });
        } else {
          messageContent.textContent = msg.content;
        }
        
        const messageTime = document.createElement('div');
        messageTime.className = 'message-time';
        messageTime.textContent = formatTime(msg.timestamp);
        
        messageEl.appendChild(messageContent);
        messageEl.appendChild(messageTime);
        
        chatMessages.appendChild(messageEl);
      });
      
      // 滚动到底部
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // 格式化时间
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
    }
    
    // 发送消息
    async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;
        
        // 如果没有当前会话，创建一个新会话
        if (currentSessionId === null) {
            createNewChat();
        }
        
        // 添加用户消息
        const userMessage = {
            role: 'user',
            content: message,
            timestamp: Date.now()
        };
        
        currentMessages.push(userMessage);
        
        // 更新UI
        messageInput.value = '';
        renderMessages();
        
        // 保存到数据库
        window.preload.dbUtil.saveChatHistory(currentSessionId, currentMessages);
        
        // 更新聊天列表
        loadChatSessions();
        
        // 获取选中的模型
        const selectedModel = modelManager.getCurrentModel();
        if (!selectedModel) {
            showNotification('请先添加模型配置', 'warning');
            return;
        }
        
        // 准备发送给AI的消息
        const aiMessages = [];
        
        // 添加系统提示词
        if (selectedModel.systemPrompt) {
            aiMessages.push({
                role: 'system',
                content: selectedModel.systemPrompt
            });
        }
        
        // 添加对话历史
        currentMessages.forEach(msg => {
            if (msg.role !== 'system') {
                aiMessages.push({
                    role: msg.role,
                    content: msg.content
                });
            }
        });
        
        try {
            // 添加AI回复占位
            const aiMessage = {
                role: 'assistant',
                content: '',
                timestamp: Date.now()
            };
            
            currentMessages.push(aiMessage);
            renderMessages();
            
            // 调用AI API并处理流式输出
            await window.preload.aiUtil.callAI(selectedModel, aiMessages, (content) => {
                aiMessage.content = content;
                renderMessages();
            });
            
            // 保存到数据库
            window.preload.dbUtil.saveChatHistory(currentSessionId, currentMessages);
            
            // 更新聊天列表
            loadChatSessions();
        } catch (error) {
            console.error('发送消息失败:', error);
            
            // 移除加载中消息
            currentMessages.pop();
            
            // 添加错误消息
            const errorMessage = {
                role: 'assistant',
                content: `发生错误: ${error.message}`,
                timestamp: Date.now()
            };
            
            currentMessages.push(errorMessage);
            
            // 更新UI
            renderMessages();
            
            // 保存到数据库
            window.preload.dbUtil.saveChatHistory(currentSessionId, currentMessages);
        }
    }
    
    // 添加模型
    function addModel() {
        const config = {
            name: modelName.value.trim(),
            model: modelId.value.trim(),
            url: apiUrl.value.trim(),
            key: apiKey.value.trim(),
            systemPrompt: systemPrompt.value.trim()
        };
        
        try {
            modelManager.addModel(config);
            
            // 更新UI
            updateModelSelect();
            updateModelList();
            
            // 清空表单
            resetModelForm();
            
            // 显示成功通知
            showNotification('模型已添加', 'success');
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }
    
    // 删除模型
    function deleteModel(index) {
        showConfirm('确定要删除这个模型吗？', (confirmed) => {
            if (confirmed) {
                try {
                    modelManager.deleteModel(index);
                    
                    // 更新UI
                    updateModelSelect();
                    updateModelList();
                    
                    // 显示成功通知
                    showNotification('模型已删除', 'success');
                } catch (error) {
                    showNotification(error.message, 'error');
                }
            }
        });
    }
    
    // 删除聊天会话
    function deleteChatSession(sessionId) {
      // 从数据库中删除
      window.preload.dbUtil.deleteChatHistory(sessionId);
      
      // 如果删除的是当前会话，清空当前会话
      if (currentSessionId === sessionId) {
        currentSessionId = null;
        currentMessages = [];
        updateChatUI();
      }
      
      // 重新加载聊天列表
      loadChatSessions();
      
      // 显示删除成功通知
      showNotification('对话已删除', 'success');
    }
    
    // 显示通知
    function showNotification(message, type = 'info', duration = 3000) {
      // 设置通知内容和类型
      notificationContent.textContent = message;
      notification.className = `notification ${type}`;
      
      // 显示通知
      notification.classList.add('show');
      
      // 设置自动关闭
      setTimeout(() => {
        hideNotification();
      }, duration);
    }
    
    // 隐藏通知
    function hideNotification() {
      notification.classList.remove('show');
    }
    
    // 设置通知关闭按钮事件
    notificationClose.addEventListener('click', hideNotification);
    
    // 显示模型选择弹窗
    function showModelSelectModal() {
      if (modelManager.getAllModels().length === 0) {
        showNotification('请先添加模型配置', 'warning');
        return;
      }
      
      // 生成模型列表
      modelSelectList.innerHTML = '';
      let activeIndex = parseInt(modelSelect.value) || 0;
      
      // 显示所有模型
      updateModelListItems(modelManager.getAllModels(), activeIndex);
      
      // 显示弹窗
      modelSelectModal.classList.add('show');
      
      // 聚焦到搜索框
      modelSelectInput.focus();
      
      // 监听键盘事件
      document.addEventListener('keydown', handleModelSelectKeydown);
    }
    
    // 更新模型列表项
    function updateModelListItems(models, activeIndex = 0) {
      modelSelectList.innerHTML = '';
      
      models.forEach((model, index) => {
        const item = document.createElement('li');
        item.className = 'model-select-item';
        if (index === activeIndex) {
          item.classList.add('active');
        }
        
        item.innerHTML = `
          <div class="model-select-name">${model.name}</div>
          <div class="model-select-shortcut">${index + 1}</div>
        `;
        
        item.addEventListener('click', () => {
          selectModel(index);
        });
        
        modelSelectList.appendChild(item);
      });
    }
    
    // 处理模型选择键盘事件
    function handleModelSelectKeydown(e) {
      const items = modelSelectList.querySelectorAll('.model-select-item');
      const activeItem = modelSelectList.querySelector('.model-select-item.active');
      let activeIndex = Array.from(items).indexOf(activeItem);
      
      // 如果正在输入搜索内容，不处理其他按键
      if (e.target === modelSelectInput) {
        if (e.key === 'Enter') {
          e.preventDefault();
          if (activeItem) {
            const index = Array.from(items).indexOf(activeItem);
            selectModel(index);
          }
        }
        return;
      }
      
      switch (e.key) {
        case 'Escape':
          hideModelSelectModal();
          break;
          
        case 'ArrowUp':
          e.preventDefault();
          if (activeIndex > 0) {
            activeItem.classList.remove('active');
            items[activeIndex - 1].classList.add('active');
            items[activeIndex - 1].scrollIntoView({ block: 'nearest' });
          }
          break;
          
        case 'ArrowDown':
          e.preventDefault();
          if (activeIndex < items.length - 1) {
            activeItem.classList.remove('active');
            items[activeIndex + 1].classList.add('active');
            items[activeIndex + 1].scrollIntoView({ block: 'nearest' });
          }
          break;
          
        case 'Enter':
          e.preventDefault();
          if (activeItem) {
            const index = Array.from(items).indexOf(activeItem);
            selectModel(index);
          }
          break;
          
        default:
          // 数字键选择（可选）
          const number = parseInt(e.key);
          if (!isNaN(number) && number >= 1 && number <= modelManager.getAllModels().length) {
            selectModel(number - 1);
          }
      }
    }
    
    // 搜索模型
    function searchModels(query) {
      const filteredModels = modelManager.getAllModels().filter(model => 
        model.name.toLowerCase().includes(query.toLowerCase())
      );
      
      updateModelListItems(filteredModels);
      
      // 如果有匹配项，选中第一个
      if (filteredModels.length > 0) {
        const firstItem = modelSelectList.querySelector('.model-select-item');
        if (firstItem) {
          firstItem.classList.add('active');
        }
      }
    }
    
    // 选择模型
    function selectModel(index) {
      try {
        // 获取当前显示的模型列表
        const displayedItems = modelSelectList.querySelectorAll('.model-select-item');
        const activeItem = modelSelectList.querySelector('.model-select-item.active');
        const activeIndex = Array.from(displayedItems).indexOf(activeItem);
        
        // 获取原始模型列表
        const allModels = modelManager.getAllModels();
        
        // 如果正在搜索，需要找到对应的原始索引
        let originalIndex = index;
        if (modelSelectInput.value.trim() !== '') {
          const searchQuery = modelSelectInput.value.toLowerCase();
          const matchingModels = allModels.filter(model => 
            model.name.toLowerCase().includes(searchQuery)
          );
          if (matchingModels.length > 0) {
            // 使用当前选中的模型名称来找到原始索引
            const selectedModelName = matchingModels[activeIndex].name;
            originalIndex = allModels.findIndex(model => model.name === selectedModelName);
          }
        }
        
        modelManager.setCurrentModel(originalIndex);
        
        // 更新下拉框的值和显示文本
        modelSelect.value = originalIndex;
        modelSelect.selectedIndex = originalIndex;
        
        // 隐藏弹窗
        hideModelSelectModal();
        
        // 显示通知
        showNotification(`已切换到模型: ${modelManager.getCurrentModel().name}`, 'success');
        
        // 清空搜索框
        modelSelectInput.value = '';
      } catch (error) {
        showNotification(error.message, 'error');
      }
    }
    
    // 隐藏模型选择弹窗
    function hideModelSelectModal() {
      modelSelectModal.classList.remove('show');
      document.removeEventListener('keydown', handleModelSelectKeydown);
      // 聚焦回输入框
      messageInput.focus();
    }
    
    // 设置事件监听
    function setupEventListeners() {
      // 发送消息
      sendButton.addEventListener('click', sendMessage);
      
      // 按Enter发送消息
      messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      
      // 输入框内容变化
      messageInput.addEventListener('input', () => {
        sendButton.disabled = messageInput.value.trim() === '';
      });
      
      // 新建聊天
      newChatBtn.addEventListener('click', createNewChat);
      startChatBtn.addEventListener('click', createNewChat);
      
      // 设置按钮
      settingsBtn.addEventListener('click', () => {
        settingsModal.classList.add('active');
      });
      
      // 关闭设置
      closeSettings.addEventListener('click', () => {
        settingsModal.classList.remove('active');
        // 重新聚焦到输入框
        messageInput.focus();
      });
      
      // 点击模态框外部关闭
      settingsModal.addEventListener('click', (e) => {
        if (e.target === settingsModal) {
          settingsModal.classList.remove('active');
          // 重新聚焦到输入框
          messageInput.focus();
        }
      });
      
      // 添加模型按钮事件监听
      addModelBtn.addEventListener('click', () => {
        if (addModelBtn.textContent === '更新模型') {
          // 获取编辑索引
          const editIndex = parseInt(addModelBtn.dataset.editIndex);
          if (!isNaN(editIndex)) {
            updateModel(editIndex);
          }
        } else {
          addModel();
        }
      });
      
      // 监听快捷键
      document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.altKey && e.key.toLowerCase() === 't') {
          e.preventDefault();
          showModelSelectModal();
        }
      });
      
      // 点击弹窗外部关闭
      modelSelectModal.addEventListener('click', (e) => {
        if (e.target === modelSelectModal) {
          hideModelSelectModal();
          // 重新聚焦到输入框
          messageInput.focus();
        }
      });
      
      // 搜索框输入事件
      modelSelectInput.addEventListener('input', (e) => {
        searchModels(e.target.value);
      });
      
      // 搜索框键盘事件
      modelSelectInput.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          const firstItem = modelSelectList.querySelector('.model-select-item');
          if (firstItem) {
            firstItem.classList.add('active');
            firstItem.scrollIntoView({ block: 'nearest' });
          }
        }
      });
    }
    
    // 显示确认对话框
    function showConfirm(message, callback) {
      confirmMessage.textContent = message;
      confirmModal.classList.add('active');
      
      // 设置确认按钮的回调
      const handleConfirm = () => {
        confirmModal.classList.remove('active');
        callback(true);
        // 移除事件监听
        confirmOk.removeEventListener('click', handleConfirm);
        confirmCancel.removeEventListener('click', handleCancel);
        closeConfirm.removeEventListener('click', handleCancel);
      };
      
      // 设置取消按钮的回调
      const handleCancel = () => {
        confirmModal.classList.remove('active');
        callback(false);
        // 移除事件监听
        confirmOk.removeEventListener('click', handleConfirm);
        confirmCancel.removeEventListener('click', handleCancel);
        closeConfirm.removeEventListener('click', handleCancel);
      };
      
      // 添加事件监听
      confirmOk.addEventListener('click', handleConfirm);
      confirmCancel.addEventListener('click', handleCancel);
      closeConfirm.addEventListener('click', handleCancel);
    }
    
    // 初始化应用
    document.addEventListener('DOMContentLoaded', () => {
      // 获取保存的模型配置
      const savedModelConfigs = window.preload.dbUtil.getModelConfig()
      if (savedModelConfigs && savedModelConfigs.length > 0) {
        modelManager.modelConfigs = savedModelConfigs
      }
      
      // 获取保存的模型索引
      const savedModelIndex = window.preload.dbUtil.getModelIndex()
      if (savedModelIndex !== undefined) {
        currentSessionId = savedModelIndex
        updateModelButtonText()
      }
      
      // 初始化其他UI元素
      init()
    });
  </script>
</body>
</html>
